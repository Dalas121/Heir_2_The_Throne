#textdomain wesnoth-h2tt
# scenario by Dalas

#define SCENARIO_TURN_LIMIT
30#enddef

#define TOD_OFFSET
-1#enddef

[scenario]
    id,map_file,name=10_Elensefar_Before,10_Elensefar_Before.map,_"The Siege of Elensefar"
    next_scenario,victory_when_enemies_defeated=00_The_Great_Continent,no
    {SCHEDULE_DYNAMIC_DAY OFFSET={TOD_OFFSET}}
    turns={SCENARIO_TURN_LIMIT}
          {SCENARIO_MUSIC loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC hunted.ogg}
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE 75}
    
    #############################
    # ELENSEFAR
    #############################
    [event] name=prestart {UNSTORE_NPC Maddock x,y=19,18 side,facing=2,se} [/event]
    [side]
        side,controller,color=2,ai,teal
        recruit=Swordsman,Pikeman
        gold,income={ON_DIFFICULTY4 80 100 120 120},{ON_DIFFICULTY4 6 10 14 14} # assume villages used for upkeep
        no_leader,team_name,user_team_name=yes,konrad,_"Elensefar"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Thief" {ON_DIFFICULTY4 2 2 3 3}}
    {STARTING_VILLAGES_AREA 2 22 21 4}
    {STARTING_VILLAGES_AREA 2 28 18 3}
    
    [event] name=prestart {UNSTORE_NPC Delfador x,y=17,19 side,facing=3,se} [/event]
    [side]
        side,controller,color=3,ai,teal
        recruit=Fire Wraith
        gold,income={ON_DIFFICULTY4 40 60 80 80},{ON_DIFFICULTY4 4 7 10 10} # assume villages used for upkeep
        no_leader,team_name,user_team_name=yes,konrad,_"Elensefar"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Giant Mudcrawler" {ON_DIFFICULTY4 2 2 3 3}}
    {STARTING_VILLAGES_AREA 3 17 15 5}
    {STARTING_VILLAGES_AREA 3 27 14 2}
    
    
    #############################
    # ELENSEFAR AI
    #############################
#define ELENSEFARIAN_AVOID_AREA
    x= 0-17,  18,  18,   18,   19,  19,   19,   20,  20,   20,   21,  21,21,21,   22,  22,   23,  23,23,   24,  24,24,   25,  25,   26,  26,26,   27,  27,   28,  28,28,   29,  29,29,   30,  30,    31-99,31-99
    y=22-99,  0-10,15-16,22-99,0-11,14-16,21-99,0-11,14-15,20-99,0-13,15,21,23-99,0-13,23-99,0-12,20,23-99,0-12,20,23-99,0-13,24-99,0-12,19,22-99,0-12,23-99,0-11,19,21-99,0-12,20,22-99,0-12,20-99,  0-13,20-99
#enddef                                       # 20,11 is avoided so that mudcrawlers don't block the granite golem
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3 offensive 0.1 0.8}
#         {VARY_AI_BY_SCHEDULE 2,3} # likely to cause lag, and not relevant since we're already fighting within strict [avoid]s
        
        {MODIFY_SIDE_AI 2 ({GOAL_SEEK_SIDE 3 4,5,6,9 0})}
        {MODIFY_SIDE_AI 3 ({GOAL_SEEK_SIDE 3   7,8,9 0})}
        
        {MODIFY_SIDE_AI 2 (
            {GOAL_LOCATION 4 x,y=29,21}
            {GOAL_LOCATION 4 x,y=27,22}
            {GOAL_LOCATION 4 x,y=25,23}
            {GOAL_LOCATION 3 x,y=26,21}
            {GOAL_LOCATION 3 x,y=24,22}
        )}
        
        {MODIFY_SIDE_AI 3 (
            {GOAL_LOCATION 4 x,y=27,13}
            {GOAL_LOCATION 4 x,y=19,12}
            {GOAL_LOCATION 4 x,y=20,11}
            {GOAL_LOCATION 3 x,y=30,13}
            {GOAL_LOCATION 3 x,y=26,15}
        )}
        
        {MODIFY_SIDE_AI 2,3 (
            {GOAL_LOCATION 2 x,y=22,19}
            {GOAL_LOCATION 2 x,y=23,18}
            {GOAL_LOCATION 2 x,y=19,20}
            {GOAL_LOCATION 1 x,y=28,18}
            {GOAL_LOCATION 1 x,y=27,19}
            {GOAL_LOCATION 1 x,y=20,17}
        )}
        
        {MODIFY_SIDE_AI 2,3 ([avoid] 
            {ELENSEFARIAN_AVOID_AREA}
        [/avoid])}
    [/event]
    
    
    #############################
    # CARAVEL AI
    #############################
    # caravels repair when they're at the docks
    [event]
        name,first_time_only=side 2 turn,no
        [heal_unit]
            {FILTER( type=Caravel
                     x=14,16
                     y=18,17 )}
            amount=8
            animate=yes
        [/heal_unit]
    [/event]
    
#define CARAVEL_MAI ID HEALX HEALY FIGHTX FIGHTY RADIUS
    [event]
        name,first_time_only=side 2 turn refresh,no
        {FILTER_CONDITION({HAVE_UNIT id={ID}})}
        [micro_ai]
            side,action,ai_type=2,delete,goto
            ca_id=mai_{ID}
        [/micro_ai]
        [micro_ai]
            side,action,ai_type=2,delete,zone_guardian
            ca_id=mai_{ID}
        [/micro_ai]
        
        # if at the healing location, stay there until full hp (unless enemies get close)
        [if] {HAVE_UNIT id,x,y,formula={ID},{HEALX},{HEALY},"(self.hitpoints < self.max_hitpoints)"} {THEN(
            [micro_ai]
                side,action,ai_type=2,add,zone_guardian
                ca_id=mai_{ID} {FILTER id={ID}}
                station_x,station_y={HEALX},{HEALY}
                {FILTER_LOCATION x,y=14-20,16-19}
            [/micro_ai]
        )}
        
        # if injured, go to the healing location
        [elseif] {HAVE_UNIT id,formula={ID},"(self.hitpoints < self.max_hitpoints/2)"} {THEN(
            [micro_ai]
                side,action,ai_type=2,add,goto
                ca_id=mai_{ID} {FILTER id={ID}}
                {FILTER_LOCATION x,y={HEALX},{HEALY}}
                [avoid]
                    x,y=1,1 # overwrite our side's normal avoid
                [/avoid]
            [/micro_ai]
        )} [/elseif]
        
        # otherwise, guard our zone normally
        {ELSE(
            [micro_ai]
                side,action,ai_type=2,add,zone_guardian
                ca_id=mai_{ID} {FILTER id={ID}}
                station_x,station_y={FIGHTX},{FIGHTY}
                {FILTER_LOCATION x,y,radius={FIGHTX},{FIGHTY},{RADIUS}}
            [/micro_ai]
        )} [/if]
    [/event]
#enddef
    {CARAVEL_MAI caravelSouth 14 18  23 22 5}
    {CARAVEL_MAI caravelNorth 16 17  22 12 3}
    {CARAVEL_MAI caravelEast  38 13  39 12 3}
    
    
    #############################
    # ARMY OF WESNOTH
    #############################
#define WESNOTH_SIDE SIDE TYPE ID TRAITS RECRUIT_LIST GOLD INCOME
    [side]
        side,controller,color={SIDE},ai,purple
        type,id,facing={TYPE},{ID},nw {MODIFICATIONS( {TRAITS} )}
        gold,income,recruit={GOLD},{INCOME},{RECRUIT_LIST}
        team_name,user_team_name=bad,_"Army of Wesnoth" {FLAG_VARIANT loyalist}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
    [event]
        name,first_time_only=side {SIDE} turn,no
        {RESET_SIDE_AI {SIDE} offensive 0.4 0.25}
#         {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME {SIDE} 1,2,3} # DISABLED - Elensefar is bottlenecked by hexes, not units
    [/event]
#enddef
    {WESNOTH_SIDE 4 Halberdier wesnoth4 ({TRAIT_RESILIENT}{TRAIT_INTELLIGENT})  "Spearman" {ON_DIFFICULTY4 30 60 120 120} {ON_DIFFICULTY4 2 6 14 14}}
    {WESNOTH_SIDE 5 Longbowman wesnoth5 ({TRAIT_RESILIENT}{TRAIT_STRONG}     )  "Bowman"   {ON_DIFFICULTY4 20 40  80  80} {ON_DIFFICULTY4 1 4 10 10}}
    {WESNOTH_SIDE 6 Lieutenant wesnoth6 ({TRAIT_STRONG}   {TRAIT_RESILIENT}  )  "Fencer"   {ON_DIFFICULTY4 20 40  80  80} {ON_DIFFICULTY4 1 4 10 10}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Pikeman"   {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Swordsman" {ON_DIFFICULTY4 0 0 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Spearman"  {ON_DIFFICULTY4 1 1 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Duelist"   {ON_DIFFICULTY4 0 1 1 1}}
    {STARTING_VILLAGES_AREA 4  32 29  5}
    {STARTING_VILLAGES_AREA 5  14 32  9}
    {STARTING_VILLAGES_AREA 6  53 31 10}
    
    
    #############################
    # CLAN FOXTAIL
    #############################
#define FOXTAIL_SIDE SIDE TYPE ID NAME TRAITS RECRUIT_LIST GOLD INCOME
    [side]
        side,controller,color={SIDE},ai,orange
        type,id,name,facing={TYPE},{ID},{NAME},se {MODIFICATIONS( {TRAITS} )}
        gold,income,recruit={GOLD},{INCOME},{RECRUIT_LIST}
        team_name,user_team_name=bad,_"Clan Foxtail" {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
    [event]
        name,first_time_only=side {SIDE} turn,no
        {RESET_SIDE_AI {SIDE} offensive 0.4 0.25}
        [if] {VARIABLE_CONDITIONAL turn_number greater_then 4} {THEN( # otherwise we retreat from the handful of units that start near our keeps
#             {VARY_AI_BY_SCHEDULE_ENEMY {SIDE} 1,2,3} # DISABLED - Elensefar is bottlenecked by hexes, not units
        )} [/if]
    [/event]
#enddef
    {FOXTAIL_SIDE 7 "Orcish Slurbow"  foxtail7 _"Agadla"   ({TRAIT_RESILIENT}{TRAIT_INTELLIGENT})  "Orcish Archer"   {ON_DIFFICULTY4 30 60 120 120} {ON_DIFFICULTY4 2 6 14 14}}
    {FOXTAIL_SIDE 8 "Goblin Pillager" foxtail8 _"Drodrish" ({TRAIT_RESILIENT}{TRAIT_STRONG}     )  "Goblin Pillager" {ON_DIFFICULTY4 20 40  80  80} {ON_DIFFICULTY4 1 4 10 10}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Orcish Crossbowman" {ON_DIFFICULTY4 0 1 3 3}} # 1 guard on Hard/Nightmare
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Orcish Grunt"       {ON_DIFFICULTY4 1 2 3 3}} # 1 guard on Normal/Hard/Nightmare
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Orcish Archer"      {ON_DIFFICULTY4 1 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Orcish Grunt"       {ON_DIFFICULTY4 0 1 1 1}} # 1 guard on Hard/Nightmare
    {STARTING_VILLAGES_AREA 7  31-99 0-9 0}
    {STARTING_VILLAGES_AREA 8   0-30 0-9 0}
    
    
    #############################
    # LI'SAR
    #############################
    [side]
        side,controller,color=9,ai,purple
        no_leader,hidden=yes,yes
        gold,income={ON_DIFFICULTY4 40 80 160 160},-2
        recruit=Heavy Infantryman
        team_name,user_team_name=bad,_"Army of Wesnoth" {FLAG_VARIANT loyalist}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Bowman" {ON_DIFFICULTY4 0 1 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Fencer" {ON_DIFFICULTY4 2 3 4 4}}
    {SILENTLY_LIMIT_LEADER_MOVES 9 1}
    [event]
        name,first_time_only=side 9 turn refresh,no
        {RESET_SIDE_AI 9 offensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 9 1,2,3}
    [/event]
    [event] # don't have any of lisar's units cost upkeep, or else the whole boats-bringing-gold gimmick is pointless
        name,first_time_only=unit placed,no
        {FILTER side=9}
        {GIVE_OBJECT_TO id=$unit.id ({EFFECT loyal ()})}
    [/event]
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # DELFADOR
        #############################
        # golems
        {GENERIC_UNIT 3 "Granite Golem" 23 18} {FACING ne} {ZONE_GUARDIAN 23 18 x,y,radius=22,18,2}
        {GENERIC_UNIT 3 "Granite Golem" 30 13} {FACING nw} {ZONE_GUARDIAN 30 13 (
            x=26,   27,   28,   29,   30,   31
            y=12-13,12-15,11-15,12-16,12-14,14 )}
        {GENERIC_UNIT 3 "Granite Golem" 21 10} {FACING ne} {ZONE_GUARDIAN 20 11 x,y,radius=18,12,3} {HITPOINTS 87} {ROLE golem1} # deliberately out of position; it starts fighting some orcs
        [event]
            name,first_time_only=side 3 turn refresh,no
            # golem1 spawns injured and isn't stationed on a village, so go back to heal if there's no enemies nearby
            {FILTER_CONDITION({HAVE_UNIT( role,formula=golem1,"(self.hitpoints < self.max_hitpoints)" )})}
            {FILTER_CONDITION({HAVE_UNIT( role=golem1 {FILTER_LOCATION x,y,radius=19,12,1} )})} 
            {FILTER_CONDITION({NOT({HAVE_UNIT x,y=19,12})})}
            
            {FILTER_CONDITION({NOT({HAVE_UNIT( side=7,8               {FILTER_LOCATION x,y,radius=20,11,2} )})})}
            {FILTER_CONDITION({NOT({HAVE_UNIT( type="Goblin Pillager" {FILTER_LOCATION x,y,radius=21,10,3} )})})}
            
            {MOVE_UNIT role=golem1 19 12} {MODIFY_UNIT role=golem1 moves 0}
        [/event]
        
        # some attackers (they'll get killed ina couple of turns)
        {GENERIC_UNIT 3 "Fire Wraith"      31 10} {FACING ne} {ZONE_GUARDIAN 31 10 x,y,radius=31,10,5} {HITPOINTS 19}
        {GENERIC_UNIT 3 "Fire Guardian"    30  8} {FACING ne} {ZONE_GUARDIAN 31 10 x,y,radius=31,10,5} {HITPOINTS 23}
        {GENERIC_UNIT 3 "Giant Mudcrawler" 31 12} {FACING ne} {ZONE_GUARDIAN 31 10 x,y,radius=31,10,5}
        
        # small island mudcrawlers
        {GENERIC_UNIT 3 "Mudcrawler"       20 11} {FACING se}
        {GENERIC_UNIT 3 "Mudcrawler"       17 13} {FACING se}
        {GENERIC_UNIT 3 "Mudcrawler"       16 12} {FACING se}
        
        
        #############################
        # MADDOCK
        #############################
        {BRAZIER_DYNAMIC_DAY 25 21 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 21 19 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 26 13 OFFSET={TOD_OFFSET}}
        [item]
            x,y,halo=30,17,items/fountain-[01~13].png:100
        [/item]
        
        {GENERIC_UNIT 2 "Swordsman" 27 13} {FACING ne} {ZONE_GUARDIAN 27 13 x,y,radius=27,14,2}
        {GENERIC_UNIT 2 "Swordsman" 19 17} {FACING se} {ZONE_GUARDIAN 19 17 x,y,radius=21,18,3}
        {GENERIC_UNIT 2 "Pikeman"   22 19} {FACING se} {ZONE_GUARDIAN 22 19 x,y,radius=21,19,2}
        {GENERIC_UNIT 2 "Thief"     28 18} {FACING ne} {ZONE_GUARDIAN 28 18 x,y,radius=28,18,1}
        {GENERIC_UNIT 2 "Swordsman" 25 23}
        {GENERIC_UNIT 2 "Thief"     24 22} {HITPOINTS 11}
        {GENERIC_UNIT 2 "Pikeman"   29 21}
        {GENERIC_UNIT 2 "Pikeman"   28 21} {HITPOINTS 9}
        {GENERIC_UNIT 2 "Thief"     28 22} {HITPOINTS 19}
        {GENERIC_UNIT 2 "Thief"     27 22}
        
        {NAMED_UNIT 2 Caravel 14 18 caravelSouth _"Elyn's Folly"       facing=sw} {HITPOINTS 71}
        {NAMED_UNIT 2 Caravel 20  8 caravelNorth _"Spear of Elensefar" facing=se}
        {NAMED_UNIT 2 Caravel 34 12 caravelEast  _"Charlock"           facing=sw}
        
        
        #############################
        # ARMY OF WESNOTH
        #############################
        {PLACE_IMAGE items/dwarven-keep-tile.png 34 31}
        
        # initial attackers
        {GENERIC_UNIT 6 "Spearman" 30 21} {FACING nw} {HITPOINTS 31}
        {GENERIC_UNIT 6 "Spearman" 29 22} {FACING ne} {HITPOINTS 16}
        {GENERIC_UNIT 6 "Spearman" 29 23} {FACING nw} {HITPOINTS 18}
        
        {GENERIC_UNIT 6 "Bowman"   22 24} {FACING ne}
        {GENERIC_UNIT 6 "Bowman"   23 25} {FACING ne}
        
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"     "Spearman"   "Spearman"   "Spearman"  }) 33 32 ({FACING sw}{ZONE_GUARDIAN 33 32 x,y,radius=34,30,3})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman" "Longbowman"}) 39 29 ({FACING se}{ZONE_GUARDIAN 39 29 x,y,radius=37,29,3})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"     "Bowman"    }) 38 28 ({FACING se}{ZONE_GUARDIAN 38 28 x,y,radius=34,30,3})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Longbowman" "Longbowman"}) 34 26 ({FACING nw}{GUARDIAN})}
        
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Spearman"   "Spearman"  }) 26 28 ({FACING sw}{GUARDIAN})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"     "Bowman"    }) 18 30 ({FACING sw}{ZONE_GUARDIAN 18 30 x,y,radius=28,28,4})}
        
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"     "none"       "Fencer"     "Fencer"    }) 40 23 ({FACING sw}{ZONE_GUARDIAN 40 23 x,y,radius=28,28,4})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Duelist"    "Duelist"   }) 43 24 ({FACING sw}{ZONE_GUARDIAN 43 24 x,y,radius=39,22,5})}
        
        
        #############################
        # CLAN FOXTAIL
        #############################
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"          "none"          "Orcish Archer"      "Orcish Archer"     }) 35  6 ({FACING sw}{ZONE_GUARDIAN 35  6 x,y,radius=33,8,4})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Orcish Archer" "Orcish Archer" "Orcish Crossbowman" "Orcish Crossbowman"}) 35  8 ({FACING sw}{ZONE_GUARDIAN 31 10 x,y,radius=33,8,4}{HITPOINTS 21})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"          "Orcish Grunt"  "Orcish Grunt"       "Orcish Grunt"      }) 34  9 ({FACING sw}{ZONE_GUARDIAN 34  9 x,y,radius=33,8,4})}
        {GENERIC_UNIT  7 "Orcish Crossbowman" 32  9} {FACING sw} {HITPOINTS 4}
        {GENERIC_UNIT  7 "Orcish Grunt"       31  9} {FACING sw}
        {GENERIC_UNIT  7 "Orcish Archer"      38 10} {FACING sw} {HITPOINTS 16} # this guy is here to give Charlock something to shoot at on turn 1
        
        {GENERIC_UNITC 8 ({ON_DIFFICULTY4 "none"          "Orcish Archer" "Orcish Crossbowman" "Orcish Crossbowman"}) 26 6 ({FACING sw}{GUARDIAN})}
        {GENERIC_UNITC 8 ({ON_DIFFICULTY4 "none"          "none"          "Orcish Grunt"       "Orcish Grunt"      }) 25 4 ({FACING se}{GUARDIAN})}
        {GENERIC_UNIT  8 "Orcish Archer" 21  9} {FACING se}
        {GENERIC_UNIT  8 "Orcish Archer" 22 10} {FACING nw}
        {GENERIC_UNIT  8 "Orcish Grunt"  20  9} {FACING se} {HITPOINTS 7}
        
        
        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SCROLL_TO 31 24}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # BLAGGARDS
        #############################
        {DELAY 500}
        [message]
            speaker=wesnoth6
            message=_"Push, you blaggards! We take the isle or it’s back to the gallows for us all!"
        [/message]
        {DELAY 250}
        {ANIMATE_HARM x,y=29,23 13 range=melee x,y=28,22}
        {ANIMATE_HARM x,y=29,23 99 range=melee x,y=28,22}
        {DELAY 250}
        {ANIMATE_HARM x,y=29,22 99 range=melee x,y=28,21}
        {DELAY 250}
        {ANIMATE_HARM x,y=30,21 10 range=melee x,y=29,21}
        {ANIMATE_HARM x,y=30,21 10 range=melee x,y=29,21}
        {ANIMATE_HARM x,y=29,21 99 range=melee x,y=30,21}
        {DELAY 500}
        # retaliation
        {MOVE_UNIT x,y=27,22 28 23}
        {ANIMATE_HARM x,y=28,23 99 range=melee x,y=29,23}
        {DELAY 250}
        {ANIMATE_HARM x,y=29,21 99 range=melee x,y=29,22}
        {DELAY 250}
        {MOVE_UNIT id=wesnoth6 34 24}
        [message]
            speaker=wesnoth6
            message=_"Damnations, still no progress! The defenders can’t keep this up forever — prepare another assault."
        [/message]
        {DELAY 250}
        [event]
            name=side 6 turn refresh
            {MOVE_UNIT   id=wesnoth6 39 24} # otherwise he makes for the slighty-closer southern keep, which is already occupied
            {MODIFY_UNIT id=wesnoth6 moves 0}
        [/event]
        
        #############################
        # KONRAD ARRIVES
        #############################
        [if] {VARIABLE_CONDITIONAL elensefar_from_north equals yes} {THEN(
            {RECALL_KONRAD_AND_COMPANIONS 45 1} {DELAY 250}
            {MODIFY_UNIT id=Konrad facing sw}
            {MODIFY_TERRAIN Ke 45 1} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 44 0} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 44 1} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 45 2} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 46 1} [redraw][/redraw] {DELAY 150}
            [capture_village]
                x,y,radius=58,4 # set to neutral
            [/capture_village]
        )}
        [elseif] {VARIABLE_CONDITIONAL elensefar_from_west equals yes} {THEN(
            {GENERIC_UNIT 1 Boat 1 36} {ROLE arrival_boat} {DELAY 250}
            {MOVE_UNIT role=arrival_boat 5 36} {KILL role=arrival_boat}
            {RECALL_XY Konrad 5 36} {MODIFY_UNIT id=Konrad facing se}
            {MOVE_UNIT id=Konrad 7 36}
            {MODIFY_TERRAIN Ke 7 36} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 8 35} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 8 36} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 7 37} [redraw][/redraw] {DELAY 150}
            {RECALL_KONRAD_AND_COMPANIONS 7 36}
            [capture_village]
                x,y,radius=7,34,5 # set to neutral
            [/capture_village]
            [capture_village]
                side,x,y=1,6,36
            [/capture_village]
        )} [/elseif]
        {ELSE( # default spawn location - southeast
            {RECALL_XY Konrad 58 34} {MODIFY_UNIT id=Konrad facing sw} {DELAY 250}
            {MOVE_UNIT id=Konrad 56 33}
            {MODIFY_TERRAIN Ke 56 33} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 55 34} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 55 33} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 56 32} [redraw][/redraw] {DELAY 150}
            {RECALL_KONRAD_AND_COMPANIONS 56 33}
            [capture_village]
                x,y,radius=51,34,6 # set to neutral
            [/capture_village]
            [capture_village]
                side,x,y=1,56,31
            [/capture_village]
        )} [/if]
        {CLEAR_VARIABLE elensefar_from_west,elensefar_from_north}
        
        #############################
        # KONRAD DIALOGUE
        #############################
        {DELAY 250}
        [message]
            speaker=Maddock
            message=_"Welcome to Elensefar, young master. Delfador has told me a great deal about you over the years! If you truly possess the potential that he claims, now is the time to start living up to it."
        [/message]
        {SCROLL_TO 28 10}
        [message]
            speaker,scroll=Maddock,no
            message=_"As you can see we’re hard-pressed, for Asheviere’s loyalists besiege the south bridge while orcs push in from the north. Every attack has been repelled, but that lieutenant of theirs is right about one thing — we can’t keep it up forever."
        [/message]
        {FIND_COMPANION_AND_SAY
            MESSAGE_ALLARIL=_"Ah’m not afraid! Jus’ give the word an’ I’ll see them chicken-hearted pox wrinklers clear back to Weldyn!"
            MESSAGE_GENERIC=_"We’re here to help, Lord Maddock. Elensefar has been a bastion of freedom against Asheviere’s tyrrany. We can’t let it fall!"
            FALLBACK_KONRAD=_"We’re here to help, Lord Maddock. Elensefar has been a bastion of freedom against Asheviere’s tyrrany. We can’t let it fall!"
        }
        [message]
            speaker=Delfador
            message=_"Exposing yourself here is a great risk, master Konrad. But your position behind enemy lines does afford us an opportunity for counterattack."
        [/message]
        [message]
            speaker=Delfador
            message=_"If you can defeat enough of their leaders to break the siege, the remainder will most certainly be forced to withdraw."
        [/message]
        [message]
            speaker=Konrad
            message=_"I won’t let you down, Delfador. Prepare for battle!"
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        {VARIABLE leaders_to_kill 3}
        {VARIABLE leaders_killed 0}
        [objectives]
            delayed_variable_substitution=yes
            [objective]
                description= _ "Defeat $leaders_to_kill enemy leaders"
                condition=win
                [show_if]{VARIABLE_CONDITIONAL leaders_killed equals       0}[/show_if]
            [/objective]
            [objective]
                description= _ "Defeat $leaders_to_kill enemy leaders ($($leaders_to_kill-$leaders_killed) remaining)"
                condition=win
                [show_if]{VARIABLE_CONDITIONAL leaders_killed greater_than 0}[/show_if]
            [/objective]
            [objective]
                {ALTERNATIVE_OBJECTIVE_CAPTION}
                description=_ "Survive until turns run out"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            [gold_carryover]
                carryover_percentage,bonus=40,no
            [/gold_carryover]
        [/objectives]
    [/event]
    
    #############################
    # APPROACH DELFADOR
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=18,18,3} )}
        [message]
            speaker=Konrad
            message=_"It’s good to see you again, Delfador. I’m glad you’re still ok!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Alive and kicking indeed, young master. But there is no time for idle chatter."
        [/message]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                          LISAR
    #######################################################################################################################################################
    #############################
    # BOATS APPEAR
    #############################
    [event]
        name=side 9 turn 1
        [message]
            speaker=Delfador
            message=_"What’s this? Master Konrad, Lord Maddock, I scry many small ships coming down the river! An ill tiding indeed, for they carry fresh fighters from Weldyn."
        [/message]
        [message]
            speaker=Maddock
            message=_"Impossible! What remains of the royal fleet already withdrew to the blockade; they don’t have the numbers for another amphibious attack."
        [/message]
        
        {GENERIC_UNIT 9 Dinghy    58 12} {ANIMATE} {FACING sw}
        {GENERIC_UNIT 9 Dinghy    58 14} {ANIMATE} {FACING sw}
        {GENERIC_UNIT 9 Outrigger 58 15} {ANIMATE} {FACING sw} {ROLE lisar_outrigger}
        {GENERIC_UNIT 9 Dinghy    57 17} {ANIMATE} {FACING sw} {ROLE boat1}
        {GENERIC_UNIT 9 Dinghy    58 19} {ANIMATE} {FACING sw} {ROLE boat2}
        [micro_ai]
            side,action,ai_type=9,add,goto
            {FILTER role=lisar_outrigger}
            {FILTER_LOCATION x,y=35,17}
        [/micro_ai]
        [micro_ai]
            side,action,ai_type=9,add,goto
            {FILTER role=boat1}
            {FILTER_LOCATION x,y=35,18}
        [/micro_ai]
        [micro_ai]
            side,action,ai_type=9,add,goto
            {FILTER role=boat2}
            {FILTER_LOCATION x,y=37,16}
        [/micro_ai]
        [micro_ai]
            side,action,ai_type=9,add,goto
            {FILTER( side,trait=9,mechanical {NOT role=lisar_outrigger}{NOT role=boat1}{NOT role=boat2} )}
            {FILTER_LOCATION x,y=36,16-17}
        [/micro_ai]
        
        [event]
            name=side 9 turn end
            [message]
                speaker=Maddock
                message=_"Damn... converted smallcraft. I shouldn’t have committed so many warships to the bridge defense.

Charlock, move to intercept! Those transports must not be allowed to land on the isle!"
            [/message]
            
            {MODIFY_UNIT id=caravelEast id Charlock} # change id to disable the existing MAI logic
            [micro_ai]
                side,action,ai_type=2,add,zone_guardian
                {FILTER id=Charlock}
                station_x,station_y=45,13
                {FILTER_LOCATION x,y=39-99,10-19}
            [/micro_ai]
        [/event]
    [/event]
    
    #############################
    # LISAR LANDS
    #############################
    [event]
        name=moveto
        {FILTER role,x,y=lisar_outrigger,35,17}
        
        {SCROLL_TO $unit.x $unit.y}
#         {KILL role=lisar_outrigger}
#         {PLACE_IMAGE "units/mechanical/outrigger.png~FL()" $unit.x $unit.y}
        {UNSTORE_NPC Lisar x,y=34,16 side,facing=9,nw}
        [modify_side]
            side,hidden=9,no
        [/modify_side]
        {FADE_MUSIC_OUT 250}
        {MODIFY_TERRAIN Ke 34 16} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 33 16} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 33 17} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 34 17} [redraw][/redraw] {DELAY 150}
        
        {FADE_MUSIC_IN 0}
        {DELAY 250}
        
        [message]
            speaker=Lisar
            message=_"Elensefar isle. Good work everyone — they weren’t ready for us to press the fishing fleet into service. But our fight’s not done yet."
        [/message]
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "none"              "Bowman"            "Longbowman"        "Longbowman"       }) 33 16 ( {ANIMATE}{FACING sw}{ZONE_GUARDIAN 33 15 x,y,radius=34,16,3} )}
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    }) 33 17 ( {ANIMATE}{FACING sw}{ZONE_GUARDIAN 31 17 x,y,radius=31,17,1} )}
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "none"              "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}) 34 17 ( {ANIMATE}{FACING sw}{ZONE_GUARDIAN 32 18 x,y,radius=34,16,3} )}
        {MODIFY_UNIT (side=9 {NOT trait=mechanical}) moves 0} # including Li'sar
        [message]
            speaker=Lisar
            message=_"Secure a beachhead and prepare to receive the rest of the boats. We must act swiftly, before they can pivot their defenses."
        [/message]
        {DELAY 500}
        
        #------------------------
        # KONRAD SPEAKS TO LI'SAR
        #------------------------
        [if] {VARIABLE_CONDITIONAL met_lisar equals yes} {THEN(
            [message]
                speaker=Konrad
                message=_"We meet again, princess! I’ve beaten you before, and I’ll do so again. Elensefar deserves a better ruler than you."
            [/message]
            [message]
                speaker=Lisar
                message=_"Konrad. I underestimated you once before — never again. You should have picked a different battle, princeling."
            [/message]
        )} {ELSE(
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"Princess Li’sar, we meet at last! I’ve heard stories about the battles you won in your mother’s name. I won’t let Elensefar be one of them!"
            [/message]
            [message]
                speaker=Lisar
                message=_"Hello, “Konrad.” I think you’re a little out of your depth — the battlefield is no place for an con artist."
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION mad}
                message=_"Your lies have sown enough discord and chaos among my people. How convenient that you’re here; I can capture both you and Maddock at the same time."
            [/message]
        )} [/if]
        
        #------------------------
        # MADDOCK SPEAKS TO LI'SAR
        #------------------------
        [event]
            name=turn 9
            {FILTER_CONDITION({HAVE_UNIT id=Lisar})}
            [message]
                speaker=Maddock
                message=_"Elensefar has weathered countless storms, princess. Your queen will be neither the first nor the last that breaks upon our shores."
            [/message]
            [message]
                speaker=Lisar
                message=_"You’ve been a capable lord, Maddock, and from what I tell you truly care about your city. If it’s any consolation, when all’s said and done I intend to make sure you stand a fair trial."
            [/message]
            [message]
                speaker=Lisar
                message=_"As for Delfador....you’re going to regret what you did to my brother."
            [/message]
        [/event]
    [/event]
    
    #############################
    # ANY BOAT UNLOADS ITS CARGO
    #############################
    [event]
        name,first_time_only=moveto,no
        {FILTER( side,trait,x,y=9,mechanical,36,16-17 {NOT role=lisar_outrigger}{NOT role=boat1}{NOT role=boat2} )} # for some reason, role doesn't accept multiple values
        {KILL id=$unit.id}
        [gold]
            side,amount=9,{ON_DIFFICULTY4 10 20 40 40}
        [/gold]
        [floating_text]
            x,y=$unit.x,$unit.y
            text= _ "<span color='#FFD700' size='x-small'>{ON_DIFFICULTY4 10 20 40 40} gold</span>"
        [/floating_text]
    [/event]
    
    #############################
    # SPAWN BOATS
    #############################
    [event]
        name,first_time_only=side 9 turn,no
        {FILTER_CONDITION({HAVE_UNIT id=Lisar})}
        {FILTER_CONDITION({LUA(<< return (wesnoth.current.turn%4==1) >>)})} # spawn on turn 5, 9, 13, etc
        
        # spawn fewer boats if Lisar is already strong
        [if] {HAVE_UNIT( side,count=9,0-99 {NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 2} )} [/if]
        [if] {HAVE_UNIT( side,count=9,0-10 {NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 3} )} [/if]
        [if] {HAVE_UNIT( side,count=9,0-8  {NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 4} )} [/if]
        [if] {HAVE_UNIT( side,count=9,0-6  {NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 5} )} [/if]
        
        {REPEAT $repeat (
            {VARIABLE_OP type  rand ("Dinghy","Dinghy","Dinghy","Outrigger")}
            {VARIABLE_OP x     rand 57,58}
            {VARIABLE_OP y     rand 11,12,13,14,15,16,17,18,19,20}
            {GENERIC_UNIT 9 $type $x $y}
        )}
        {CLEAR_VARIABLE x,y,type,rand}
    [/event]
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # LISAR ATTACK BOAT SUNK
    #############################
    [event]
        name=last breath
        {FILTER role=lisar_outrigger}
        {FILTER_CONDITION({NOT({HAVE_UNIT id=Lisar})})}
        
        [message]
            role=lisar_outrigger
            caption,image=_"Li’sar",portraits/lisar.webp
            message=_"—how did you know?! It seems I’m not half so clever as I thought."
        [/message]
        [message]
            role=lisar_outrigger
            caption,image=_"Li’sar",portraits/lisar.webp
            message=_"You win this round, Konrad. I need to get out of here before this boat takes any more damage."
        [/message]
        {MOVE_UNIT role=lisar_outrigger 58 17}
        {KILL side,trait=9,mechanical}
        
        {VARIABLE_OP leaders_killed add 1}
        {FIRE_EVENT check_for_victory}
        [show_objectives]
        [/show_objectives]
    [/event]
    #############################
    # LISAR ESCAPE BOATS SUNK
    #############################
    [event]
        name=last breath
        {FILTER side,trait=9,mechanical}
        {FILTER_CONDITION({HAVE_UNIT( count,role=0-1,lisar_outrigger {OR role=boat1} {OR role=boat2} )})}
        [message]
            speaker=Lisar
            message=_"The last boat is under attack! I hate to retreat, but I can’t risk being trapped here and captured."
        [/message]
        {FIRE_EVENT lisar_flee_on_boat}
    [/event]
    #############################
    # LISAR LAST BREATH
    #############################
    [event]
        name=last breath
        {FILTER id=Lisar}
        {FIRE_EVENT lisar_flee_on_boat}
    [/event]
    [event]
        name=lisar_flee_on_boat
        [if] {VARIABLE_CONDITIONAL met_lisar equals yes} {THEN(
            [message]
                speaker=Lisar
                message=_"You prove your skills once again, cousin. A worthy foe indeed... Elensefar survives another day."
            [/message]
        )} {ELSE(
            [message]
                speaker=Lisar
                message=_"I underestimated you, “cousin” — it seems you’re more than just a good actor and a pretty face. I may be forced to flee the field today, but this isn’t over."
            [/message]
        )} [/if]
        
        [store_unit]
            {FILTER( role=lisar_outrigger {OR role=boat1} {OR role=boat2} )}
            variable=stored_boats
        [/store_unit]
        {STORE_NPC Lisar}
        {FAKE_UNIT_MOVE $stored_Lisar.x $stored_boats[0].x $stored_Lisar.y $stored_boats[0].y 9 "Princess" canrecruit=yes}
        
        [foreach]
            array,variable=stored_boats,boat
            [do] {MOVE_UNIT id=$boat.id 58 17} {KILL id=$boat.id} [/do]
        [/foreach]
        {KILL side,trait=9,mechanical}
        
        {VARIABLE_OP leaders_killed add 1}
        {FIRE_EVENT check_for_victory}
        [show_objectives]
        [/show_objectives]
    [/event]
    
    
    #############################
    # THREE LEADERS KILLED
    #############################
    [event]
        name,first_time_only=die,no
        {FILTER( side=4,5,6,7,8 {AND canrecruit=yes} )}
        {VARIABLE_OP leaders_killed add 1}
        {FIRE_EVENT check_for_victory}
        [show_objectives]
        [/show_objectives]
    [/event]
    [event]
        name=check_for_victory
        {FILTER_CONDITION({VARIABLE_CONDITIONAL leaders_killed greater_than_equal_to $leaders_to_kill})}
#         [message]
#             speaker=Konrad
#             message=_"That’s three down! Surely the besiegers must be about to break?"
#         [/message]
        {DELAY 250}
        [if] {HAVE_UNIT( count=5-99 {AND side=4,5,6,7,8,9} {FILTER_LOCATION x,y,radius=19,18,4} )} {THEN(
            {VARIABLE lisar_almost_won yes}
        )} [/if]
        
        #------------------------
        # HUMANS DEAD: ORCS FLEE
        #------------------------
        [if] {HAVE_UNIT race,canrecruit=orc,yes} {THEN(
            [message]
                race,canrecruit=orc,yes
                message=_"Forget this! I was promised an easy fight full of plunder, not a flank and a rout! Deal with your problems yourselves, pink-skins."
            [/message]
            {KILL side=7,8}
            [if] {VARIABLE_CONDITIONAL lisar_almost_won equals yes} {THEN(
                [message]
                    id=Lisar {OR( side=4,5,6,7,8 {AND race,canrecruit,formula=human,yes,"(self.hitpoints>0)"} )}
                    message=_"They’ve gone. I hate to retreat, but without support I can’t risk being trapped here and captured. We came so close to taking the city!"
                [/message]
            )} {ELSE(
                [message]
                    id=Lisar {OR( side=4,5,6,7,8 {AND race,canrecruit,formula=human,yes,"(self.hitpoints>0)"} )}
                    message=_"They’ve gone. I hate to retreat, but without support I can’t risk being trapped here and captured. We already pushed dangerously hard just to get this far."
                [/message]
            )} [/if]
        )}
        #------------------------
        # ORCS DEAD: HUMANS FLEE
        #------------------------
        {ELSE(
            [message]
                race,canrecruit=human,yes {NOT id=Lisar}
                message=_"Useless orcs! You were hired for a siege, not a rout!"
            [/message]
            [if] {VARIABLE_CONDITIONAL lisar_almost_won equals yes} {THEN(
                [message]
                    id=Lisar {OR( side=4,5,6,7,8 {AND race,canrecruit=human,yes} )}
                    message=_"I hate to retreat, but we’re already overextended pushing this far into the city. With the north shore fallen, I can’t risk the whole army any further. We came so close to taking the city!"
                [/message]
            )} {ELSE(
                [message]
                    id=Lisar {OR( side=4,5,6,7,8 {AND race,canrecruit=human,yes} )}
                    message=_"I hate to retreat, but with the north shore fallen we have little hope of taking the city. We already pushed dangerously hard just to get this far — I can’t risk things any further."
                [/message]
            )} [/if]
        )} [/if]
        
        [if] {HAVE_UNIT id=Lisar} {THEN(
            {FIRE_EVENT lisar_flee_on_boat}
        )} [/if]
        {KILL side=4,5,6,7,8,9}
        
        #------------------------
        # CELEBRATION
        #------------------------
        {DELAY 750}
        [message]
            speaker=Konrad
            message=_"We’ve driven them back! The siege of Elensefar is over!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Well done, Konrad. I was worried when you decided to join the fight, but Maddock and I could not have carried the day without your help. Together we have won a great victory over tyrrany."
        [/message]
        [message]
            speaker=Maddock
            message=_"Pigs will fly before the silver city bows to any queen. After the thrashing we gave them, they won’t return anytime soon."
        [/message]
        [message]
            speaker=Maddock
            message=_"Konrad, Elensefar is in your debt today. What soldiers I can spare are now yours to command — including many of the Thieves’ Guild’s more enterprising young robbers."
        [/message]
        {NEW_RECRUIT3 (Swordsman,Pikeman,Thief) _"You can now recruit Swordsmen, Pikemen, and Thieves!" human-loyalists/swordsman.png human-loyalists/pikeman.png human-outlaws/thief+female.png}
        [message]
            speaker=Maddock
            message=_"May they serve you well. Keep up the good fight, my lord."
        [/message]
        
        {CLEAR_VARIABLE leaders_to_kill,leaders_killed,lisar_almost_won}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=time over
    [/event]
[/scenario]




#undef ELENSEFARIAN_AVOID_AREA
#undef CARAVEL_MAI
#undef WESNOTH_SIDE
#undef FOXTAIL_SIDE
#undef TOD_OFFSET
#undef SCENARIO_TURN_LIMIT
