#textdomain wesnoth-h2tt
# scenario by Dalas

#define TOD_OFFSET
-4#enddef


[scenario]
    name=_"scenario name^Test of the Clans"
    {MAP_DYNAMIC 47_Test_of_the_Clans}
    next_scenario,victory_when_enemies_defeated=00_The_Great_Continent,no
    {SCHEDULE_DYNAMIC_DAY OFFSET={TOD_OFFSET}}
    turns=-1
          {SCENARIO_MUSIC loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC battle-epic.ogg}
    {EXTRA_SCENARIO_MUSIC casualties_of_war.ogg}
    {EXTRA_SCENARIO_MUSIC legends_of_the_north.ogg}
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE}
    {STARTING_VILLAGES 1 6}
    
    #############################
    # HORSE CLANS
    #############################
#define CLAN_SIDE SIDE ID NAME COLOR TRAITS
    [side]
        side,controller,color={SIDE},ai,wesred
        type="Grand Knight"
        id,name={ID},{NAME}
        {MODIFICATIONS( {TRAITS} )}
        facing=se
        gold=  {ON_DIFFICULTY4 50 100 150 200}
        income={ON_DIFFICULTY4 -4   1   6  11} # assume each enemy will have around 8 villages
        recruit=Horseman,Lancer,Knight
        team_name,user_team_name=plainsmen,_"Plainsmen" {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES {SIDE} 20}
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 5}
    {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Spearman" {ON_DIFFICULTY4 2 4 6 8}}
    [event]
        name=prestart
        {TEAM_COLOR_OVERRIDE id={ID} {COLOR}}
    [/event]
    [event]
        name,first_time_only=side {SIDE} turn,no
        {RESET_SIDE_AI {SIDE} offensive 0.8 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME {SIDE} 1,$lisar_side}
    [/event]
#enddef
    # names/colors are used on the overworld too
    {CLAN_SIDE 2 Alric _"Sir Alric"  darkred ({TRAIT_STRONG}   {TRAIT_INTELLIGENT})}
    {CLAN_SIDE 3 Daryn _"Sir Daryn"  white   ({TRAIT_RESILIENT}{TRAIT_STRONG     })}
    {CLAN_SIDE 4 Bayar _"Lord Bayar" gold    ({TRAIT_QUICK}    {TRAIT_RESILIENT  })}
    {CLAN_SIDE 5 Ruga  _"Sir Ruga"   orange  ({TRAIT_STRONG}   {TRAIT_RESILIENT  })}
    
    #############################
    # LISAR
    #############################
    {LISAR_SIDE 6 (RECRUIT=Heavy Infantryman,Bowman)}
    {LISAR_CHOOSE_CONTROLLER
        (IF_AI_CONTROL=
            {SILENTLY_LIMIT_LEADER_MOVES $lisar_side 1}
            {LIMIT_CONTEMPORANEOUS_RECRUITS $lisar_side "Longbowman"    3}
            {LIMIT_CONTEMPORANEOUS_RECRUITS $lisar_side "Fencer"        2}
        )
    }
    {STARTING_VILLAGES $lisar_side 4}
    [event]
        name=side $lisar_side turn
        first_time_only=no
        {RESET_SIDE_AI $lisar_side defensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME $lisar_side 2,3,4,5}
        {MODIFY_AI_ADD_GOAL $lisar_side ({GOAL_SEEK_SIDE 5 0.5 0})} # prefer attacking the southern (closest) enemy leader
        {RETREAT_WHEN_WEAK $lisar_side {ON_DIFFICULTY4 0-3 0-4 0-5 0-5} (
            {GOAL_LOCATION 3 x,y=80,27}
            {GOAL_LOCATION 2 x,y=83,26}
            {GOAL_LOCATION 1 x,y=81,26}
            {GOAL_LOCATION 1 x,y=84,25}
            {GOAL_LOCATION 1 x,y=84,24}
        )}
    [/event]
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # TERRAIN
        #############################
        {BRAZIER_DYNAMIC_DAY 12 18 OFFSET={TOD_OFFSET}}
        
        {PLACE_IMAGE items/gold-coins-large.png  15 21} # locations are used in the "see gold" event
        {PLACE_IMAGE items/gold-coins-medium.png 14 20}
        {PLACE_IMAGE items/gold-coins-medium.png 15 20}
        
        {PLACE_IMAGE items/gold-coins-medium.png 25 17}
        {PLACE_IMAGE items/gold-coins-medium.png 26 17}
        
        {PLACE_IMAGE items/gold-coins-medium.png 10 18}
        {PLACE_IMAGE items/gold-coins-small.png  11 19}
        
        #############################
        # WESNOTH GUARDS
        #############################
        {OBJECT_MOONBOW ({FILTER id=leader2})}
        
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"   "Bowman"  "Longbowman" "Longbowman"}) 12 17 ({FACING ne}{ZONE_GUARDIAN 12 17 x,y,radius=10,18,3})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"   "Bowman"  "Bowman"     "Bowman"    }) 16 19 ({FACING se}{ZONE_GUARDIAN 16 19 x,y,radius=12,20,4})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"   "none"    "Spearman"   "Spearman"  })  8 16 ({FACING se}{ZONE_GUARDIAN  8 16 x,y,radius=8,18,3})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"   "none"    "none"       "Bowman"    }) 13 20 ({FACING se}{ZONE_GUARDIAN 13 20 x,y,radius=10,20,5})}
        
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"   "Bowman"  "Bowman"     "Bowman"    }) 25 15 ({FACING se}{ZONE_GUARDIAN 25 15 x,y,radius=27,16,3})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"   "none"    "Peasant"    "Peasant"   }) 27 16 ({FACING se}{ZONE_GUARDIAN 27 16 x,y,radius=27,16,3})}
        
        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SCROLL_TO 13 1}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # KONRAD ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Konrad 13 1} {DELAY 250}
        {MODIFY_TERRAIN Ke 13 1} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 12 1} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 13 2} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 14 1} {REDRAW} {DELAY 150}
        {RECALL_KONRAD_AND_COMPANIONS 13 1}
        
        #############################
        # INTRODUCTORY DIALOGUE
        #############################
        {DELAY 500}
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Villains! You have pillaged a great treasure from the halls of my home. Return it at once, and your lives may yet be spared!"
        [/message]
        [message]
            speaker=leader3
            message=_"You— you’re Konrad! The false prince himself, here?!"
        [/message]
        [message]
            speaker=leader2
            message=_"I’m not about to surrender myself nor my property to a rebel! To arms, loyalists, and make ready to repel the invaders!"
        [/message]
        [message]
            speaker=Kalenz
            message=_"It is war, then. Such an insult against my Aethenwood kin shall not go unpunished."
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description=_"Defeat the Master Bowman"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
        [/objectives]
    [/event]
    
    #############################
    # SMALLTALK
    #############################
    [event]
        name=turn 10
        {FIRE_EVENT say_smalltalk}
    [/event]
    
    #############################
    # SEE GOLD
    #############################
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x=15,14,15,25,26,10,11
                y=21,20,20,17,17,18,19
            [/filter_location]
        [/filter]
        [message]
            speaker=Konrad
            message=_"Seeing all this stolen gold and broken treasures kindles a great coldness in my heart. Asheviere has much to pay for..."
        [/message]
        [allow_undo]
        [/allow_undo]
    [/event]
    
    #############################
    # MOONBOW IS USED
    #############################
    [event]
        name=attack
        {FILTER id=leader2}
        {FILTER_ATTACK range=ranged}
        {FIRE_EVENT explain_moonbow}
    [/event]
    [event]
        name=attack
        {FILTER_SECOND id=leader2}
        {FILTER_ATTACK range=ranged}
        {FIRE_EVENT explain_moonbow}
    [/event]
    [event]
        name=explain_moonbow
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"You dare use that bow against us? The Moonbows belong to the elves; you know nothing about them and have no right to lay hand on one!"
        [/message]
        [message]
            speaker=leader3
            message=_"I know enough: I’ve trained in archery my entire life and never seen a bow to rival this one. Fighting with it is my best chance at beating you!"
        [/message]
    [/event]
    
    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=attack
        {FILTER_ATTACK range=melee}
        {FILTER_SECOND id=leader2}
        {VARIABLE s13_failed_achievement yes}
    [/event]
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # JAVELINEER DIES
    #############################
    [event]
        name=last breath
        {FILTER id=leader3}
        [message]
            speaker=leader3
            message=_"Urgh..."
        [/message]
        [event]
            name=die
            [message]
                speaker=Konrad
                message=_"One leader has been defeated, but he is not the one who holds the bow."
            [/message]
        [/event]
    [/event]
    
    #############################
    # MASTER BOWMAN DIES
    #############################
    [event]
        name=last breath
        {FILTER id=leader2}
        
        [if] {VARIABLE_CONDITIONAL s13_failed_achievement not_equals yes} {THEN({ACHIEVE s13})} [/if]
        {CLEAR_VARIABLE s13_failed_achievement}
        
        #------------------------
        # LEADER FLEES
        #------------------------
        [message]
            speaker=leader2
            message=_"The rebels are too powerful! Mercy, Konrad! I’m just doing my duty to defend my country, as ordered by my sovereign, the queen!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Surrender your elven weapon, and swear an oath to never again take up arms again me or my allies. I am the true sovereign in Wesnoth, and will give you but one chance at redemption."
        [/message]
        [message]
            speaker=leader2
            message=_"But Asheviere will kill me! ...I suppose you will too. If you really are the heir, and an elf-lover besides, then I suppose our pillage does most rightfully belong to you. Here, take it, and leave the rest of us alive!"
        [/message]
        {STORE_UNIT_VAR id=leader2 x moonbowX}
        {STORE_UNIT_VAR id=leader2 y moonbowY}
        {PLACE_IMAGE items/bow-crystal-2.png $moonbowX $moonbowY}
        
        [modify_unit]
            {FILTER id=$second_unit.id}
            experience="$( $this_unit.experience + 24 )" # manually award XP to whoever killed the leader, since we need to move/kill him as part of the cutscene, which breaks the normal death events
        [/modify_unit]
        {MOVE_UNIT id=leader2 10 20}
        {KILL id=leader2}
        
        #------------------------
        # GAIN GOLD
        #------------------------
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message=_"You have gained 300 gold!"
        [/message]
        {SOUND gold.ogg}
        [gold]
            side,amount=1,300 # after 40% carryover, this is worth only 120 gold (still a lot) — but it's in addition to our regular early finish bonus
        [/gold]
        [remove_item]
            image=items/gold-coins-large.png
        [/remove_item]
        [remove_item]
            image=items/gold-coins-medium.png
        [/remove_item]
        [remove_item]
            image=items/gold-coins-small.png
        [/remove_item]
        {DELAY 500}
        
        #------------------------
        # ENEMIES FLEE
        #------------------------
        [if] {HAVE_UNIT side=2,3} {THEN(
            [companion_message]
                priority="Kalenz" # because he's an elf and these guys attacked the Aethenwood
                message_Kalenz=_"As for the rest of you — begone! Return to your homes in Westin and never-again trouble my people, lest the wrath of the elves fall upon you!"
                message_Harper=_"An’ that goes for th’ rest o’ you too! Get out o’ here, an’ tell Westin we sent you!"
                message_Moremirmu=_"And the rest of you — begone! For lo! The Light stands with Konrad, and only those of darkness dare to oppose him."
                message_Ulfdain=_"An’ that goes for th’ rest o’ you too, ye horse-faced sons o’ elves! Run back to Westin afore I boil yer kneecaps inside yer skulls!"
#                 message_Jeniver=_"" # she's not the type to make threats
                message_Dosh=_"Da rest of you better be leavin’ now too. Konrad good troll-friend. You don’ wanna see what troll do to you if you keep fightin’ Konrad."
                fallback_Konrad=_"And that goes for the rest of you too! Return to your homes in Westin, and trouble the Aethenwood no more."
            [/companion_message]
            {CUTSCENE_ENEMIES_RETREAT 2,3 10 20}
        )} [/if]
        
        #------------------------
        # KONRAD TAKES MOONBOW
        #------------------------
        [message]
            speaker=Konrad
            message=_"With that, Fort Tahn is ours, the Aethenwood’s gold reclaimed, and this Moonbow recaptured! Once peace is restored this weapon belongs in a museum, but for now I choose to wield it in battle against the dark queen. May its silver never tarnish."
        [/message]
        {MOVE_UNIT id=Konrad $moonbowX $moonbowY}
        {REMOVE_IMAGE $moonbowX $moonbowY}
        {CLEAR_VARIABLE moonbowX,moonbowY}
        {OBJECT_MOONBOW (
            {FILTER id=Konrad}
            image="attacks/bow-elven-magic.png"
            name=_"Elvish Moonbow"
            description=_"This magical bow adds the <i>slows</i> special to Konrad’s ranged attacks, and lets them deal either pierce or arcane damage."
        )}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]

#undef TOD_OFFSET
#undef CLAN_SIDE
