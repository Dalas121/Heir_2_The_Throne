#textdomain wesnoth-h2tt
# scenario by Dalas

#define TOD_OFFSET
-4#enddef


[scenario]
    name=_"scenario name^The Battle for Wesnoth"
    {MAP_DYNAMIC 48_Dan_Tonk}
    next_scenario,victory_when_enemies_defeated=00_The_Great_Continent,no
    {SCHEDULE_DYNAMIC_DAY OFFSET={TOD_OFFSET}}
    turns=-1
    {SCENARIO_MUSIC silence.ogg}
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE}
    
    #############################
    # REINFORCEMENT SIDES
    #############################
#define WELDYN_MOAT_SLF
    # used for ALL our AIs, not just these ones
    # avoid far enough that we won't leave Weldyn's walls to fight merfolk in the river,
    # but not so far that we can't wade into the river when we were never behind walls in the first place
    terrain=W* # not W*^*, or we match bridges
    {AND x,y,radius=18,22,10}
#enddef
#define REINFORCEMENT_AI SIDE SNUM X Y VARY_AI_BY_SCHEDULE
    [event]
        name=side {SIDE} turn
        first_time_only=no
        {RESET_SIDE_AI {SIDE} offensive 0.8 0.1}
        {MODIFY_SIDE_AI {SIDE} (
            [avoid]
                {WELDYN_MOAT_SLF}
            [/avoid]
        )}
        # if this side just spawned new units recently, AND if enemies are near our spawn point
        # then be aggressive even if it's an unfavorable time of day
        # note that this affects all units from this side, even if they're elsewhere on the map
        [if]
            {VARIABLE_CONDITIONAL turn_number less_than_equal_to "$( $latest_{SNUM} + 2 )"}
            {HAVE_UNIT( side=1,$lisar_side {FILTER_LOCATION x,y,radius={X},{Y},6} )}
        {THEN(
            # do nothing. Be normally aggressive
        )} {ELSE(
            {VARY_AI_BY_SCHEDULE}
        )} [/if]
    [/event]
#enddef
    #------------------------
    # FELL-HANDS
    #------------------------
    [side]
        side,controller,color=2,ai,brown
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 2 s41 19  1 ({VARY_AI_BY_SCHEDULE_ENEMY           2 1,$lisar_side})}
    
    #------------------------
    # DAN'TONK
    #------------------------
    [side]
        side,controller,color=3,ai,wesred
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 3 s48  1 11 ({VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 3 1,$lisar_side})}
    
    #------------------------
    # WHITEFANGS
    #------------------------
    [side]
        side,controller,color=4,ai,white
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 4 s42 53 41 ({VARY_AI_BY_SCHEDULE_ENEMY           4 1,$lisar_side})}
    
    #------------------------
    # HORSE CLANS
    #------------------------
    [side]
        side,controller,color=5,ai,wesred
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 5 s47 22 40 ({VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 5 1,$lisar_side})}
    
    #############################
    # ORCISH AUXILIARIES
    #############################
    [side]
        side,controller,color=6,ai,black
        no_leader=yes
        gold=  {ON_DIFFICULTY4 75 150 225 300}
        income={ON_DIFFICULTY4 -2   4  10  16} # don't make these guys a serious threat, just a "speedbump" on the way to fight Asheviere
        recruit=Goblin Spearman,Orcish Grunt,Orcish Archer
        team_name,user_team_name=wesnoth,_"Orcish Auxiliaries" {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=prestart
        {NAMED_UNIT 6 "Orcish Warrior" 33  3 leader3top _"Shnog"  ()} {LEADER} {FACING se}
        {NAMED_UNIT 6 "Orcish Warrior" 38 23 leader3mid _"Agnarz" ()} {LEADER} {FACING ne}
        {NAMED_UNIT 6 "Orcish Warrior" 60 32 leader3bot _"Arob"   ()} {LEADER} {FACING nw}
    [/event]
    {STARTING_VILLAGES_AREA 6 33  3 9}
    {STARTING_VILLAGES_AREA 6 39 23 5}
    {STARTING_VILLAGES_AREA 6 60 32 9}
    {SILENTLY_LIMIT_LEADER_MOVES 6 3}
    
    #
    # retreat to hexes near our keep, preferring village/castle hexes
    # but don't retreat to any hexes within 1 radius - otherwise we might block recruiting
    #
#define SIMPLE_RETREAT LEADERID X Y
    [if] {HAVE_UNIT id={LEADERID}} {THEN(
        {RETREAT_WHEN_WEAK 6 {ON_DIFFICULTY4 0-7 0-9 0-11 0-13} ( # remember that some of these units will be goblins
            {GOAL_LOCATION 2 (
                [and]
                    x,y,radius={X},{Y},3
                    terrain=C*^*,*^V*
                [/and]
                {NOT x,y,radius={X},{Y},1}
            )}
            {GOAL_LOCATION 1 (
                [and]
                     x,y,radius={X},{Y},3
                [/and]
                {NOT x,y,radius={X},{Y},1}
            )}
        )}
    )} [/if]
#enddef
    [event]
        name=side 6 turn
        first_time_only=no
        {RESET_SIDE_AI 6 offensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY 6 1,$lisar_side}
        {MODIFY_SIDE_AI 6 (
            [avoid]
                {WELDYN_MOAT_SLF}
            [/avoid]
        )}
        {SIMPLE_RETREAT leader3top 33  2} # deliberately off-center
        {SIMPLE_RETREAT leader3mid 39 23} # deliberately off-center
        {SIMPLE_RETREAT leader3bot 60 31} # deliberately off-center
    [/event]
    
    #############################
    # ASHEVIERE
    #############################
    [side]
        side,controller,color=7,ai,purple
        no_leader=yes
        gold=        0
        income=      0 # set this later, using the $asheviere_income variable, so we can add/subtract more easily
        village_gold={ON_DIFFICULTY4  0   1   1   1}
        recruit= # use only extra_recruit
        team_name,user_team_name=wesnoth,_"Royal Guards" {FLAG_VARIANT loyalist}
    [/side]
    [event]
        name=prestart
        {NAMED_UNIT 7 "Dark Queen" 18 22 Asheviere   _"Asheviere"   extra_recruit="Royal Guard,Halberdier,Master at Arms,Dragoon"} {LEADER} {FACING ne}
        {NAMED_UNIT 7 Lieutenant   21 27 leader2bot  _"Sir Aeollet" extra_recruit=Swordsman,Pikeman,Longbowman                   } {LEADER} {FACING ne}
        {NAMED_UNIT 7 Lieutenant   21 18 leader2top  _"Sir Gunter"  extra_recruit=Swordsman,Pikeman,Longbowman                   } {LEADER} {FACING ne}
        {NAMED_UNIT 7 Lieutenant   12 19 leader2left _"Sir Aebaud"  extra_recruit=Swordsman,Pikeman,Longbowman                   } {LEADER} {FACING nw}
        {VARIABLE asheviere_income {ON_DIFFICULTY4 32 -32 0 32}}
        
        # if the player didn't complete S14 Gryphon Mountain (which they probably didn't), give Asheviere some Gryphons
        # if the player did    complete S14 Gryphon Mountain, Asheviere loses some income
        [if] {VARIABLE_CONDITIONAL bm_s14_fought_burlin not_equals yes} {THEN(
            {KILL id=leader2left}
            {NAMED_UNIT 7 "Dwarvish Pathfinder" 12 19 burlin _"Beastmaster Burlin" extra_recruit="Gryphon Rider"} {LEADER} {FACING nw}
        )} {ELSE(
            {VARIABLE_OP asheviere_income sub $s50_burlin_income_penalty}
        )} [/if]
        
        # if the player used the whirlpool to gain extra turns, Asheveire gets extra income
        [if]
            {VARIABLE_CONDITIONAL bm_milestone_finale_original not_equals $null}
            {VARIABLE_CONDITIONAL bm_turns greater_than $bm_milestone_finale_original}
        {THEN(
            {VARIABLE_OP asheviere_income add "$( ($bm_turns - $bm_milestone_finale_original) * $s50_extra_income_per_scenario )"}
        )} [/if]
        
        [modify_side]
            side=7
            income=$asheviere_income
        [/modify_side]
        {CLEAR_VARIABLE base_income}
    [/event]
{STARTING_VILLAGES_ALL 7}
     # completely immobile. Make sure she stays on her keep (which we also make a village overlay, so she can heal) and behind her guards
    {SILENTLY_LIMIT_LEADER_MOVES 7 0}
    
    # Asheviere's AI gets a whole section further down. It's too long to fit cleanly here.
    
    #############################
    # LISAR
    #############################
    {LISAR_SIDE 8
        (RECRUIT=Shock Trooper,Longbowman,Duelist)
        (INCOME={ON_DIFFICULTY4 10 16 22 28}) # extra base income for the finale (which might still be doubled if we did Cliffs of Thoria)
    }                                         # a player who's manually controlling Li'sar won't benefit, but I expect them to have built up veterans by now instead
    {LISAR_CHOOSE_CONTROLLER
        (IF_AI_CONTROL=
            {SILENTLY_LIMIT_LEADER_MOVES $lisar_side 3}
        )
    }
    [event]
        name=side $lisar_side turn
        first_time_only=no
        {RESET_SIDE_AI $lisar_side offensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME $lisar_side 2,3,4,5}
        
        [if] {VARIABLE_CONDITIONAL lisar_at_forward_keep equals yes} {THEN(
            {RETREAT_WHEN_WEAK $lisar_side {ON_DIFFICULTY4 0-4 0-6 0-8 0-10} (
                {GOAL_LOCATION 3 x,y=39,20}
                {GOAL_LOCATION 3 x,y=35,22}
                {GOAL_LOCATION 2 x,y=34,23}
                {GOAL_LOCATION 1 x,y=35,24}
                {GOAL_LOCATION 1 x,y=36,23}
                {GOAL_LOCATION 1 x,y=41,21}
                {GOAL_LOCATION 1 x,y=42,21}
                {GOAL_LOCATION 1 x,y=38,21}
            )}
        )} {ELSE(
                {GOAL_LOCATION 1 x,y,radius=57,12,1}
        )} [/if]
    [/event]
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    ASHEVIERE AI
    #######################################################################################################################################################
#define WELDYN_SECTOR_AVOID HEXES_X HEXES_Y WML_IF_AVOID
    # Weldyn is surrounded by both walls and a moat. If walls are overwhelmed, fall back to the moat
    # To achieve this, check multiple overlapping wall quadrants. If we're weak and the enemy is strong, avoid that section
    {GET_ARMY_LEVELS 2,3,4,5,6,7   (VARNAME=good_levels) (ARMY_FILTER={FILTER_LOCATION x,y=${HEXES_X},${HEXES_Y}})}
    {GET_ARMY_LEVELS 1,$lisar_side (VARNAME=bad_levels ) (ARMY_FILTER={FILTER_LOCATION x,y=${HEXES_X},${HEXES_Y}})}
#     [if]
#         {VARIABLE_CONDITIONAL good_levels    less_than_equal_to {ON_DIFFICULTY4 4 6  8 10}}
#         {VARIABLE_CONDITIONAL bad_levels  greater_than_equal_to {ON_DIFFICULTY4 6 8 10 12}}
#     {THEN(
        # if we do want to avoid this section, run some arbitrary WML (probably new defensive goals)
        {WML_IF_AVOID}
#     )} {ELSE(
        # if we don't want to avoid this section, clear its variables
        {CLEAR_VARIABLE {HEXES_X},{HEXES_Y} 
#     )} [/if]
#enddef
#define WELDYN_VARYING_GOAL VALUE X Y
    # {VALUE} * (0.5 + (radius-6 units + radius-10 units) / weldyn-center-15 units ) 
    #           only include VISIBLE enemies
    # i.e. if 100% of Konrad's nearby army is 0-6  hexes away, x2.5 our base {VALUE}
    # i.e. if 100% of Konrad's nearby army is 7-10 hexes away, x1.5 our base {VALUE}
    # i.e. if  50% of Konrad's nearby army is 0-6  hexes away, x1.5 our base {VALUE}
    # i.e. if  50% of Konrad's nearby army is 7-10 hexes away, x1.0 our base {VALUE}
    # i.e. if   0% of Konrad's nearby army is 0-10 hexes away, x0.5 our base {VALUE}
    [store_unit]
        {FILTER( side=1,$lisar_side {FILTER_LOCATION x,y,radius={X},{Y},6} )}
        variable=inner_radius
    [/store_unit]
    [store_unit]
        {FILTER( side=1,$lisar_side {FILTER_LOCATION x,y,radius={X},{Y},10} )}
        variable=outer_radius
    [/store_unit]
    [store_unit]
        {FILTER( side=1,$lisar_side {FILTER_LOCATION x,y,radius=18,22,15} )}
        variable=weldyn_total
    [/store_unit]
    {MODIFY_SIDE_AI 7 ({GOAL_LOCATION "$( {VALUE} * (0.5 + ($inner_radius.length + $outer_radius.length) / $weldyn_total.length) )" x,y={X},{Y}})}
    {CLEAR_VARIABLE inner_radius,outer_radius,weldyn_radius}
#enddef
    [event]
        name=prestart
        {VARIABLE asheviere_posture attack}
    [/event]
    [event]
        name=side 7 turn
        first_time_only=no
        
        #############################
        # DETERMINE POSTURE
        #############################
        # if we're weak, and if we PLUS our allies are weak around Weldyn, then defend. Otherwise, attack
        #
        # gold costs are more precise than levels, but costs are more likely to be rebalanced, and levels are easier to guesstimate
        # ignore role=weldyn_guard units, so that I can place/change those without worrying about messing up the AI
        {GET_ARMY_LEVELS 7           (VARNAME=asheviere_levels ) (ARMY_FILTER={NOT role=weldyn_guard}                                      )}
        {GET_ARMY_LEVELS 2,3,4,5,6,7 (VARNAME=all_nearby_levels) (ARMY_FILTER={NOT role=weldyn_guard} {FILTER_LOCATION x,y,radius=18,22,12})}
        [if]
            {VARIABLE_CONDITIONAL asheviere_posture equals    attack}
            {VARIABLE_CONDITIONAL asheviere_levels  less_than {ON_DIFFICULTY4  5  8 11 14}}
            {VARIABLE_CONDITIONAL all_nearby_levels less_than {ON_DIFFICULTY4 10 13 16 19}}
        {THEN(
            {VARIABLE asheviere_posture defend}
        )} [/if]
        
        # if we're already defending, require a much higher threshold to switch to attacking again
        # this also determines the size of our initial attack, since we start off with very little gold
        [if]
            {VARIABLE_CONDITIONAL asheviere_posture equals    defend}
            {VARIABLE_CONDITIONAL asheviere_levels  less_than {ON_DIFFICULTY4 15 18 21 24}}
            {VARIABLE_CONDITIONAL all_nearby_levels less_than {ON_DIFFICULTY4 20 23 26 29}}
        {THEN(
            {VARIABLE asheviere_posture attack}
        )} [/if]
        {CLEAR_VARIABLE asheviere_levels,all_nearby_levels}
        
        #############################
        # IF ATTACKING...
        #############################
        # if we're attacking, use our regular VARY_AI_BY_SCHEDULE logic
        [if] {VARIABLE_CONDITIONAL asheviere_posture equals attack} {THEN(
            {RESET_SIDE_AI 7 offensive 0.4 0.25}
            {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 7 1,$lisar_side}
            {MODIFY_SIDE_AI 7 (
                [avoid]
                    {WELDYN_MOAT_SLF}
                [/avoid]
            )}
        )}
        
        #############################
        # IF DEFENDING...
        #############################
        {ELSE(
            {RESET_SIDE_AI 7 offensive 0.2 0.8}
            
            #------------------------
            # DEFENSIVE GOALS
            #------------------------
            # outer wall goals: east
            {WELDYN_VARYING_GOAL 4  24 20}
            {WELDYN_VARYING_GOAL 4  25 21}
            {WELDYN_VARYING_GOAL 1  24 21}
            {WELDYN_VARYING_GOAL 2  25 22}
            {WELDYN_VARYING_GOAL 4  25 23}
            {WELDYN_VARYING_GOAL 3  24 23}
            {WELDYN_VARYING_GOAL 1  24 24}
            {WELDYN_VARYING_GOAL 3  25 26}
            {WELDYN_VARYING_GOAL 2  23 26}
            
            # outer wall goals: northeast
            {WELDYN_VARYING_GOAL 4  23 18}
            {WELDYN_VARYING_GOAL 3  21 17}
            {WELDYN_VARYING_GOAL 4  20 17}
            {WELDYN_VARYING_GOAL 2  22 17}
            {WELDYN_VARYING_GOAL 1  21 18}
            {WELDYN_VARYING_GOAL 1  22 18}
            {WELDYN_VARYING_GOAL 1  22 19}
            
            # outer wall goals: northwest
            {WELDYN_VARYING_GOAL 4  17 17}
            {WELDYN_VARYING_GOAL 4  16 16}
            {WELDYN_VARYING_GOAL 4  14 17}
            {WELDYN_VARYING_GOAL 2  14 18}
            {WELDYN_VARYING_GOAL 1  15 18}
            {WELDYN_VARYING_GOAL 1  16 17}
            
            # outer wall goals: west
            {WELDYN_VARYING_GOAL 4  12 18}
            {WELDYN_VARYING_GOAL 4  11 19}
            {WELDYN_VARYING_GOAL 3  11 20}
            {WELDYN_VARYING_GOAL 1  12 19}
            
            # outer wall goals: west
            {WELDYN_VARYING_GOAL 4  11 22}
            {WELDYN_VARYING_GOAL 2  11 23}
            {WELDYN_VARYING_GOAL 4  11 24}
            {WELDYN_VARYING_GOAL 3  12 21}
            {WELDYN_VARYING_GOAL 2  12 22}
            {WELDYN_VARYING_GOAL 1  12 23}
            {WELDYN_VARYING_GOAL 2  12 24}
            
            # outer wall goals: southwest
            {WELDYN_VARYING_GOAL 4  13 26}
            {WELDYN_VARYING_GOAL 2  15 26}
            {WELDYN_VARYING_GOAL 4  16 28}
            {WELDYN_VARYING_GOAL 3  15 28}
            {WELDYN_VARYING_GOAL 2  16 27}
            {WELDYN_VARYING_GOAL 2  27 28}
            
            # outer wall goals: south
            {WELDYN_VARYING_GOAL 4  19 29}
            {WELDYN_VARYING_GOAL 4  22 27}
            {WELDYN_VARYING_GOAL 3  21 28}
            {WELDYN_VARYING_GOAL 1  20 26}
            {WELDYN_VARYING_GOAL 1  20 27}
            {WELDYN_VARYING_GOAL 1  21 27}
            
            #------------------------
            # AVOID QUADRANTS
            #------------------------
            # determine which (if any) quadrants to avoid. {WELDYN_SECTOR_AVOID} will clear these variables if the area is safe to enter.
            # we do this to try and defend the moat, instead of continually trying to attack across it into an already-conquered position
            #
            # these areas are large - we only retreat if the enemy is strong AND we are weak
            # some of the goals here will overlap - that's ok. If we've lost multiple overlapping sectors then it's extra-important we defend that area
            {VARIABLE avoidEastX "22,   23,   24,   25,   26,   27,   28   "}
            {VARIABLE avoidEastY "14-26,15-30,15-29,16-29,17-28,18-28,17-27"}
            {WELDYN_SECTOR_AVOID avoidEastX avoidEastY (
                {WELDYN_VARYING_GOAL 3  19 20}
                {WELDYN_VARYING_GOAL 4  20 20}
                {WELDYN_VARYING_GOAL 1  21 21}
                {WELDYN_VARYING_GOAL 5  21 22}
                {WELDYN_VARYING_GOAL 5  21 23}
                {WELDYN_VARYING_GOAL 1  21 24}
                {WELDYN_VARYING_GOAL 4  20 24}
                {WELDYN_VARYING_GOAL 3  19 25}
            )}
            
            {VARIABLE avoidNorthEastX "13,   14,   15,   16,   17,   18,   19,   20,   21,   22,   23,   24,   25,   26,   27,   28   "}
            {VARIABLE avoidNorthEastY "14-16,13-16,13-17,12-17,13-18,12-18,13-19,13-19,14-20,14-20,15-21,15-21,16-22,16-21,17-21,17-20"}
            {WELDYN_SECTOR_AVOID avoidNorthEastX avoidNorthEastY (
                {WELDYN_VARYING_GOAL 3  16 20}
                {WELDYN_VARYING_GOAL 4  17 20}
                {WELDYN_VARYING_GOAL 1  18 19}
                {WELDYN_VARYING_GOAL 5  19 20}
                {WELDYN_VARYING_GOAL 5  20 20}
                {WELDYN_VARYING_GOAL 1  21 21}
                {WELDYN_VARYING_GOAL 4  21 22}
                {WELDYN_VARYING_GOAL 3  21 23}
            )}
            
            {VARIABLE avoidSouthEastX "15,   16,   17,   18,   19,   20,   21,   22,   23,   24,   25,   26,   27,   28   "}
            {VARIABLE avoidSouthEastY "28-30,27-30,27-31,26-31,26-31,25-30,25-31,24-30,24-30,23-29,23-29,23-28,24-28,17-20"}
            {WELDYN_SECTOR_AVOID avoidSouthEastX avoidSouthEastY (
                {WELDYN_VARYING_GOAL 3  21 22}
                {WELDYN_VARYING_GOAL 4  21 23}
                {WELDYN_VARYING_GOAL 1  21 24}
                {WELDYN_VARYING_GOAL 5  20 24}
                {WELDYN_VARYING_GOAL 5  19 25}
                {WELDYN_VARYING_GOAL 1  18 25}
                {WELDYN_VARYING_GOAL 4  17 25}
                {WELDYN_VARYING_GOAL 3  16 24}
            )}
            
            # covers northwest, west, and southwest
            # it's not likely that players attack from this direction
            {VARIABLE avoidWestNorthWestX "8,    9,    10,   11,   12,   13,   14,   15,   15,   16,   16,   17,   17,   18,   18   "}
            {VARIABLE avoidWestNorthWestY "17-25,17-26,16-26,16-27,15-27,15-28,14-28,14-20,25-29,13-19,25-29,14-19,26-30,14-18,26-29"}
            {WELDYN_SECTOR_AVOID avoidWestNorthWestX avoidWestNorthWestY (
                {WELDYN_VARYING_GOAL 3  17 20}
                {WELDYN_VARYING_GOAL 4  16 20}
                {WELDYN_VARYING_GOAL 1  15 21}
                {WELDYN_VARYING_GOAL 5  15 22}
                {WELDYN_VARYING_GOAL 5  15 23}
                {WELDYN_VARYING_GOAL 1  15 24}
                {WELDYN_VARYING_GOAL 4  16 24}
                {WELDYN_VARYING_GOAL 3  17 25}
            )}
            
            #------------------------
            # SET AVOIDS
            #------------------------
#define ASHEVEIRE_AVOID_SUF
    # always avoid the moat
    {WELDYN_MOAT_SLF}
    
    # avoid a ring around Weldyn. Prevent a 7mp quick Royal Guard from leaving,
    # but allow 8+ mp scouts to escape and cap villages, even now that we're defensive
    [or]
        {AND x,y,radius=18,22,14}
        {NOT x,y,radius=18,22,7}
    [/or]
    
    # avoid any areas that've been flagged by {WELDYN_SECTOR_AVOID}
    [or]
        x=$avoidEastX
        y=$avoidEastY
    [/or]
    [or]
        x=$avoidNorthEastX
        y=$avoidNorthEastY
    [/or]
    [or]
        x=$avoidSouthEastX
        y=$avoidSouthEastY
    [/or]
    [or]
        x=$avoidWestNorthWestX
        y=$avoidWestNorthWestY
    [/or]
#enddef
            {MODIFY_SIDE_AI 7 (
                [avoid]
                    {ASHEVEIRE_AVOID_SUF}
                [/avoid]
            )}
            
            #------------------------
            # RETREAT FROM AVOIDS
            #------------------------
            [micro_ai]
                side,action,ai_type=7,add,coward
                ca_id=asheveire_retreat_mai
                {FILTER( {FILTER_LOCATION({ASHEVEIRE_AVOID_SUF})} )}
                distance=8 # arbitrarily picked; hopefully this is a good number
                seek_x,seek_y=18,22
                attack_if_trapped=yes
            [/micro_ai]
            [event]
                name=side turn end
                [micro_ai]
                    side,action,ai_type=7,delete,coward
                    ca_id=asheveire_retreat_mai
                [/micro_ai]
            [/event]
        )} [/if]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        #############################
        # TERRAIN
        #############################
        [multihex_image]
            x,y=18,22
            image=terrain/weldyn_walls.png
        [/multihex_image]
        {PLACE_IMAGE items/dwarven-keep-tile.png 38 23}
        {PLACE_IMAGE items/dwarven-keep-tile.png 39 22}
        
        {BRAZIER_DYNAMIC_DAY 16 21 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 16 23 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 20 21 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 20 23 OFFSET={TOD_OFFSET}}
        
        {BRAZIER_DYNAMIC_DAY 15 18 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 12 24 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 19 28 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 23 19 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 24 24 OFFSET={TOD_OFFSET}}
        
        #############################
        # INNER GUARDS
        #############################
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 19 22 ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 19 22 x,y,radius=18,22,3})}
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 19 23 ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 19 23 x,y,radius=18,22,3})}
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 17 22 ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING nw}{ROLE weldyn_guard}{ZONE_GUARDIAN 17 22 x,y,radius=18,22,3})}
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 17 23 ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING sw}{ROLE weldyn_guard}{ZONE_GUARDIAN 17 23 x,y,radius=18,22,3})}
        
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "Longbowman"  "Longbowman"  "Master Bowman"}) 20 20 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 20 20 x,y,radius=19,22,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "Pikeman"     "Pikeman"     "Pikeman"      }) 21 23 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 21 23 x,y,radius=19,22,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "Longbowman"  "Longbowman"  "Master Bowman"}) 20 24 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 20 24 x,y,radius=19,23,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "none"        "Swordsman"   "Swordsman"    }) 16 20 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 16 20 x,y,radius=18,21,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "none"        "Longbowman"  "Longbowman"   }) 15 23 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 15 23 x,y,radius=17,23,3})}
        
        #############################
        # BRIDGE GUARDS
        #############################
        # These are our special bridge sappers. We give them the "sapper" ability further down.
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Cavalier" "Cavalier"}) 22 24 bridgeGuardSE _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING se}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Cavalier" "Cavalier"}) 22 20 bridgeGuardNE _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING ne}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Dragoon"  "Cavalier"}) 18 18 bridgeGuardN  _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING ne}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Cavalier" "Cavalier"}) 14 20 bridgeGuardNW _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING nw}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Dragoon"  "Cavalier"}) 14 24 bridgeGuardSW _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING sw}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Dragoon"  "Cavalier"}) 18 26 bridgeGuardS  _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING se}{ROLE weldyn_guard})}
        
        #############################
        # OUTER GUARDS
        #############################
        # don't make too many of these into ZONE_GUARDIANs, because the guardian AI might prevent them from coming to help Asheviere if she's attacked from a different direction
        # also because they can't participate in sector retreats
        # East:
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Swordsman"  "Swordsman"   "Swordsman"   "Royal Guard"}) 24 23 ({FACING ne}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Longbowman"  "Longbowman"  "Longbowman" }) 25 23 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 25 23 x,y,radius=21,23,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Pikeman"    }) 25 21 ({FACING ne}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Swordsman"   "Swordsman"   "Swordsman"  }) 24 20 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 24 20 x,y,radius=21,23,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Halberdier" }) 23 18 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 23 18 x,y,radius=19,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Longbowman" "Longbowman"  "Longbowman"  "Longbowman" }) 20 17 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 20 17 x,y,radius=19,20,5})}
        # West:
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Pikeman"    "Pikeman"     "Pikeman"     "Halberdier" }) 17 17 ({FACING ne}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Longbowman"  "Longbowman"  "Longbowman" }) 16 16 ({FACING nw}{ROLE weldyn_guard}{ZONE_GUARDIAN 16 16 x,y,radius=17,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Pikeman"    }) 12 18 ({FACING nw}{ROLE weldyn_guard}{ZONE_GUARDIAN 12 18 x,y,radius=16,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Longbowman"  "Longbowman" }) 12 21 ({FACING nw}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Longbowman" "Longbowman"  "Longbowman"  "Longbowman" }) 11 22 ({FACING sw}{ROLE weldyn_guard}{ZONE_GUARDIAN 11 22 x,y,radius=16,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Swordsman"   "Swordsman"   "Swordsman"  }) 13 26 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 13 26 x,y,radius=17,24,5})}
        # South:
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Longbowman" "Longbowman"  "Longbowman"  "Longbowman" }) 22 27 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 22 27 x,y,radius=18,25,4})} # can be attacked without countering
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Swordsman"   "Swordsman"   "Royal Guard"}) 19 29 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 19 29 x,y,radius=18,26,4})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Pikeman"    }) 15 28 ({FACING sw}                                                           )}
        
        #############################
        # ORCISH GUARDS
        #############################
        # North:
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Warrior"     "Orcish Warrior"    })  36  2  ({FACING se}{ZONE_GUARDIAN 36  2 x,y,radius=33,1,4})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Archer"      "Orcish Archer"     })  32  3  ({FACING se}{ZONE_GUARDIAN 32  3 x,y,radius=33,2,3})}
        # Mid:
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Grunt"    "Orcish Warrior"     "Orcish Warrior"    })  41 21  ({FACING nw}{ZONE_GUARDIAN 41 21 x,y,radius=41,22,2})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"       "Orcish Warrior"    })  40 23  ({FACING ne}{ZONE_GUARDIAN 40 23 x,y,radius=39,22,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Crossbowman" "Orcish Crossbowman"})  35 22  ({FACING nw}{ZONE_GUARDIAN 35 22 x,y,radius=37,22,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Archer"      "Orcish Archer"     })  34 23  ({FACING se}{ZONE_GUARDIAN 34 23 x,y,radius=37,22,3})}
        # South:
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Grunt"    "Orcish Warrior"     "Orcish Warrior"    })  60 28  ({FACING nw}{ZONE_GUARDIAN 60 28 x,y,radius=61,30,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"       "Orcish Warrior"    })  58 30  ({FACING ne}{ZONE_GUARDIAN 58 30 x,y,radius=60,31,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Crossbowman" "Orcish Crossbowman"})  57 32  ({FACING nw}{ZONE_GUARDIAN 57 32 x,y,radius=59,32,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Archer"      "Orcish Archer"     })  61 32  ({FACING se}{ZONE_GUARDIAN 61 32 x,y,radius=60,31,3})}
        
        #############################
        # ADD SAPPER ABILITY
        #############################
        #
        # 25 hitpoints is an important threshold: A strong Iron Mauler led by Li'sar at day deals 23 damage vs a Dragoon.
        # The fire damage exception is also important. Not only is it realistic, but Delfador can easily bypass 25 damage with a leadership/AMLAed Fire Wraith.
        # Don't let any of those guranteed units beat sappers; require the player to have invested in non-default units instead.
        #
        # This 25 damage threshold can be crossed by Horsemen-line units (either from Blackwater or from Test of the Clans), 
        # Cavaliers, Masters-at-Arms, Halberdiers, Tritons/Hoplites, Thunderer-line units, and Granite Golems.
        # Or, by investing multiple AMLAs into a single unit.
        #
        {GIVE_OBJECT_TO id=bridgeGuardSE,bridgeGuardNE,bridgeGuardN,bridgeGuardNW,bridgeGuardSW,bridgeGuardS (
            id=sapper_ability_object
            {EFFECT overlay add=halo/bomb-overlay.png}
            {EFFECT new_ability ([abilities]
                [dummy]
                    id,name=sapper,_"sapper"
                    description= _ "This unit is carrying explosives. When defeated, it will destroy whatever terrain it is standing on.

This unit will not detonate if reduced to <span color='red'>negative 25 hitpoints</span> or less, as long as the vanshiquing damage type is not fire."
                [/dummy]
            [/abilities])}
        )}
        [event]
            name=side 7 turn refresh
            first_time_only=no
            # prevent the bridge guards from moving. They start on the bridge and they should stay there.
            {MODIFY_UNIT id=bridgeGuardSE,bridgeGuardNE,bridgeGuardN,bridgeGuardNW,bridgeGuardSW,bridgeGuardS moves 0}
        [/event]
        [event]
            name=attack
            # if battle has reached the center of Weldyn, release any remaining bridge guards from their vigil - they're needed to help fight
            {FILTER_SECOND( side=7 {FILTER_LOCATION x,y,radius=18,22,1} )}
            [event]
                name=side 7 turn
                {REMOVE_OBJECT sapper_ability_object ()}
                {MODIFY_UNIT id=bridgeGuardSE id genericGuard1}
                {MODIFY_UNIT id=bridgeGuardNE id genericGuard2}
                {MODIFY_UNIT id=bridgeGuardN  id genericGuard3}
                {MODIFY_UNIT id=bridgeGuardNW id genericGuard4}
                {MODIFY_UNIT id=bridgeGuardSW id genericGuard5}
                {MODIFY_UNIT id=bridgeGuardS  id genericGuard6}
            [/event]
        [/event]
        
        #############################
        # IMPLEMENT SAPPER DETONATION
        #############################
        [event]
            name=last breath 
            first_time_only=no
            {FILTER ability=sapper} 
            
            # manually award XP to whoever got the kill, since we needed to manually kill the sapper as part of this event
            [modify_unit]
                {FILTER id=$second_unit}
                experience="$( $this_unit.experience + 8*$unit.level )"
            [/modify_unit]
            
            #------------------------
            # FAILED DETONATION
            #------------------------
            [if]
                {VARIABLE_CONDITIONAL unit.hitpoints less_than_equal_to -25}
                {VARIABLE_CONDITIONAL second_attack.type not_equals fire}
            {THEN(
                # if this is our first time blocking a unit, explain it to the player
                [if] {VARIABLE_CONDITIONAL explained_blocked not_equals yes} {THEN(
                    [message]
                        speaker=unit
                        message= _ "Ack!"
                    [/message]
                    {KILL id=$unit.id ANIMATE=yes}
                    [if] {VARIABLE_CONDITIONAL explained_detonated not_equals yes} {THEN(
                        [message]
                            speaker=Konrad
                            message= _ "That guard was carrying some kind of strange device! Whatever it was, we slew him with such a mighty blow that he had not the chance to use it."
                        [/message]
                    )} {ELSE(
                        [message]
                            speaker=Konrad
                            message= _ "Well done! We slew this guard with such a mighty blow that he had not a chance to destroy his bridge."
                        [/message]
                    )} [/if]
                )}
                # if we've already explained blocking, don't do anything special
                {ELSE(
                    {KILL id=$unit.id ANIMATE=yes}
                )} [/if]
                {VARIABLE explained_blocked yes}
            )}
            #------------------------
            # SUCCESSFUL DETONATION
            #------------------------
            {ELSE(
                # if this is our first time detonating, explain it to the player
                [if] {VARIABLE_CONDITIONAL explained_detonated not_equals yes} {THEN(
                    [if] {VARIABLE_CONDITIONAL second_attack.type equals fire} {THEN(
                        [message]
                            speaker=unit
                            message= _ "The fire is getting to the explosive powder! Your majesty—"
                        [/message]
                    )}
                    {ELSE(
                        # if the killer is flying/swimming, call that out in the message
                        [if] {HAVE_UNIT( id=$second_unit.id {AND( race=merman,gryphon {OR type_adv_tree="Fire Guardian"} )} )}
                        {THEN(
                            [message]
                                speaker=unit
                                message= _ "Argh! Your majesty... it doesn’t even need to walk..."
                            [/message]
                        )} {ELSE(
                            [message]
                                speaker=unit
                                message= _ "Argh! Your majesty... the plan..."
                            [/message]
                        )} [/if]
                        [message]
                            speaker=Asheviere
                            message= _ "Carry out your orders. Do not disappoint me."
                        [/message]
                    )} [/if]
                )} [/if]
                {VARIABLE explained_detonated yes}
                
                # explode the bridge
                {SOUND fuse.ogg}
                {DELAY 1000}
                {KILL id=$unit.id}
                {SOUND dragonstick.ogg}
                [item]
                    name=bridge_explosion
                    x,y=$unit.x,$unit.y
                    halo="halo/flame-burst-[1,2,3,4,5,6,7,8].png~SCALE(200,300)"
                [/item]
                {DELAY 550}
                [terrain]
                    x,y=$unit.x,$unit.y
                    layer=overlay
                    terrain="^" # not rubble, or else we give Konrad a good defensive spot, defeating the purpose of blowing up the bridge 
                [/terrain]
                {PLACE_IMAGE scenery/castle-ruins3.png $unit.x $unit.y}
                {PLACE_IMAGE scenery/trash.png         $unit.x $unit.y}
                {DELAY 550}
                [remove_item]
                    image=bridge_explosion
                [/remove_item]
            )} [/if]
        [/event]
        
        
        #############################
        # KONRAD
        #############################
        {RECALL_KONRAD_AND_COMPANIONS 57 16}
        {TELEPORT_UNIT x,y=58,16 56 16}
        
        {UNSTORE_NPC Lisar x,y=34,25 side=$lisar_side}
        {MODIFY_UNIT side=1,$lisar_side facing sw}
        {WARVEN_OR_GUARD "Heavy Infantryman" 55 13 sw x,y,radius=55,13,1}
        
        {SCROLL_TO 56 16}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Asheviere"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # VICTORY
    #############################
    [event]
        name=last breath
        {FILTER id=Asheviere}
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
#undef TOD_OFFSET
#undef SIMPLE_RETREAT
#undef REINFORCEMENT_AI
#undef WELDYN_MOAT_SLF
#undef WELDYN_SECTOR_AVOID
