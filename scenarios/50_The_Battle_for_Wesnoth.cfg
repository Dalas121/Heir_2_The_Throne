#textdomain wesnoth-h2tt
# scenario by Dalas

#define TOD_OFFSET
-4#enddef


[scenario]
    name=_"scenario name^The Battle for Wesnoth"
    {MAP_DYNAMIC 48_Dan_Tonk}
    next_scenario,victory_when_enemies_defeated=00_The_Great_Continent,no
    {SCHEDULE_DYNAMIC_DAY OFFSET={TOD_OFFSET}}
    turns=-1
    {SCENARIO_MUSIC silence.ogg}
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE}
    
    #############################
    # ASHEVIERE
    #############################
    [side]
        side,controller,color=2,ai,purple
        no_leader=yes
        gold=        0
        income=      0 # set this later, using the $asheviere_income variable, so we can add/subtract more easily
        village_gold={ON_DIFFICULTY4  0   1   1   1}
        recruit= # use only extra_recruit
        team_name,user_team_name=wesnoth,_"Royal Guards" {FLAG_VARIANT loyalist}
    [/side]
    [event]
        name=prestart
        {NAMED_UNIT 2 "Dark Queen" 18 22 Asheviere   _"Asheviere"   extra_recruit="Royal Guard,Halberdier,Master at Arms"} {LEADER} {FACING ne}
        {NAMED_UNIT 2 Lieutenant   21 27 leader2bot  _"Sir Aeollet" extra_recruit=Swordsman,Pikeman,Longbowman           } {LEADER} {FACING ne}
        {NAMED_UNIT 2 Lieutenant   21 18 leader2top  _"Sir Gunter"  extra_recruit=Swordsman,Pikeman,Longbowman           } {LEADER} {FACING ne}
        {NAMED_UNIT 2 Lieutenant   12 19 leader2left _"Sir Aebaud"  extra_recruit=Swordsman,Pikeman,Longbowman           } {LEADER} {FACING nw}
        {VARIABLE asheviere_income {ON_DIFFICULTY4 32 -32 0 32}}
        
        # if the player didn't complete S14 Gryphon Mountain (which they probably didn't), give Asheviere some Gryphons
        # if the player did    complete S14 Gryphon Mountain, Asheviere loses some income
        [if] {VARIABLE_CONDITIONAL bm_s14_fought_burlin not_equals yes} {THEN(
            {KILL id=leader2left}
            {NAMED_UNIT 2 "Dwarvish Pathfinder" 12 19 burlin _"Beastmaster Burlin" extra_recruit="Gryphon Rider"} {LEADER} {FACING nw}
        )} {ELSE(
            {VARIABLE_OP asheviere_income sub $s50_burlin_income_penalty}
        )} [/if]
        
        # if the player used the whirlpool to gain extra turns, Asheveire gets extra income
        [if]
            {VARIABLE_CONDITIONAL bm_milestone_finale_original not_equals $null}
            {VARIABLE_CONDITIONAL bm_turns greater_than $bm_milestone_finale_original}
        {THEN(
            {VARIABLE_OP asheviere_income add "$( ($bm_turns - $bm_milestone_finale_original) * $s50_extra_income_per_scenario )"}
        )} [/if]
        
        [modify_side]
            side=2
            income=$asheviere_income
        [/modify_side]
        {CLEAR_VARIABLE base_income}
    [/event]
    {STARTING_VILLAGES_ALL 2}
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Dragoon {ON_DIFFICULTY4 1 2 3 4}} # any side 2 leader can recruit these
    
    #############################
    # ORCISH AUXILIARIES
    #############################
    [side]
        side,controller,color=3,ai,black
        no_leader=yes
        gold=  {ON_DIFFICULTY4 75 150 225 300}
        income={ON_DIFFICULTY4 -2   4  10  16} # don't make these guys a serious threat, just a "speedbump" on the way to fight Asheviere
        recruit=Goblin Spearman
        team_name,user_team_name=wesnoth,_"Orcish Auxiliaries" {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=prestart
        {NAMED_UNIT 3 "Orcish Warrior" 33  3 leader3top _"Snog"   ()} {LEADER} {FACING se}
        {NAMED_UNIT 3 "Orcish Warrior" 38 23 leader3mid _"Agnarz" ()} {LEADER} {FACING ne}
        {NAMED_UNIT 3 "Orcish Warrior" 60 32 leader3bot _"Arob"   ()} {LEADER} {FACING nw}
    [/event]
    {STARTING_VILLAGES_AREA 3 33  3 9}
    {STARTING_VILLAGES_AREA 3 39 23 5}
    {STARTING_VILLAGES_AREA 3 60 32 9}
    {SILENTLY_LIMIT_LEADER_MOVES 3 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Orcish Grunt"  {ON_DIFFICULTY4 1 2 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Orcish Archer" {ON_DIFFICULTY4 1 2 3 4}}
    
    #############################
    # FELL-HANDS
    #############################
    [side]
        side,controller,color=4,ai,brown
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    
    #############################
    # DAN'TONK
    #############################
    [side]
        side,controller,color=5,ai,wesred
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    
    #############################
    # WHITEFANGS
    #############################
    [side]
        side,controller,color=6,ai,white
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    
    #############################
    # HORSE CLANS
    #############################
    [side]
        side,controller,color=7,ai,wesred
        no_leader,hidden=yes,yes
        team_name=wesnoth
    [/side]
    
    # if not 2-7, change Asheviere's AI level calculations
    
    
    #######################################################################################################################################################
    #                                                                       ENEMY AI
    #######################################################################################################################################################
#define WELDYN_MOAT_SLF
    # avoid far enough that we won't leave Weldyn's walls to fight merfolk in the river,
    # but not so far that we can't wade into the river when we were never behind wall sin the first place
    terrain=Ww,Wo
    {AND x,y,radius=18,22,10}
#enddef
#define WELDYN_SECTOR_AVOID HEXES_X HEXES_Y WML_IF_AVOID
    # Weldyn is surrounded by both walls and a moat. If walls are overwhelmed, fall back to the moat
    # To achieve this, check multiple overlapping wall quadrants. If we're badly outnumbered, avoid that section
    {GET_ARMY_LEVELS 2,3,4,5,6,7   (VARNAME=good_levels) (ARMY_FILTER={FILTER_LOCATION x,y=${HEXES_X},${HEXES_Y}})}
    {GET_ARMY_LEVELS 1,$lisar_side (VARNAME=bad_levels ) (ARMY_FILTER={FILTER_LOCATION x,y=${HEXES_X},${HEXES_Y}})}
    [if]
        {VARIABLE_CONDITIONAL good_levels    less_than_equal_to {ON_DIFFICULTY4 4 6  8 10}}
        {VARIABLE_CONDITIONAL bad_levels  greater_than_equal_to {ON_DIFFICULTY4 6 8 10 12}}
    {THEN(
        # if we do want to avoid this section, run some arbitrary WML (probably new defensive goals)
        {WML_IF_AVOID}
    )} {ELSE(
        # if we don't want to avoid this section, clear its variables
        {CLEAR_VARIABLE {HEXES_X},{HEXES_Y} 
    )} [/if]
#enddef
    #############################
    # ASHEVIERE
    #############################
    [event]
        name=prestart
        {VARIABLE asheviere_posture attack}
    [/event]
    [event]
        name=side 2 turn
        first_time_only=no
        
        #------------------------
        # DETERMINE POSTURE
        #------------------------
        # if we're weak, and if we PLUS our allies are weak around Weldyn, then defend. Otherwise, attack
        #
        # gold costs are more precise than levels, but costs are more likely to be rebalanced, and levels are easier to guesstimate
        # ignore role=weldyn_guard units, so that I can place/change those without worrying about messing up the AI
        {GET_ARMY_LEVELS 2           (VARNAME=asheviere_levels ) (ARMY_FILTER={NOT role=weldyn_guard}                                      )}
        {GET_ARMY_LEVELS 2,3,4,5,6,7 (VARNAME=all_nearby_levels) (ARMY_FILTER={NOT role=weldyn_guard} {FILTER_LOCATION x,y,radius=18,22,12})}
        [if]
            {VARIABLE_CONDITIONAL asheviere_posture equals    attack}
            {VARIABLE_CONDITIONAL asheviere_levels  less_than {ON_DIFFICULTY4  5  8 11 14}}
            {VARIABLE_CONDITIONAL all_nearby_levels less_than {ON_DIFFICULTY4 10 13 16 19}}
        {THEN(
            {VARIABLE asheviere_posture defend}
        )} [/if]
        
        # if we're already defending, require a much higher threshold to switch to attacking again
        # this also determines the size of our initial attack, since we start off with very little gold
        [if]
            {VARIABLE_CONDITIONAL asheviere_posture equals    defend}
            {VARIABLE_CONDITIONAL asheviere_levels  less_than {ON_DIFFICULTY4 15 18 21 24}}
            {VARIABLE_CONDITIONAL all_nearby_levels less_than {ON_DIFFICULTY4 20 23 26 29}}
        {THEN(
            {VARIABLE asheviere_posture attack}
        )} [/if]
        {CLEAR_VARIABLE asheviere_levels,all_nearby_levels}
        
        #------------------------
        # IF ATTACKING...
        #------------------------
        # if we're attacking, use our regular VARY_AI_BY_SCHEDULE logic
        [if] {VARIABLE_CONDITIONAL asheviere_posture attack} {THEN(
            {RESET_SIDE_AI 2 offensive 0.4 0.25}
            {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 2 1,$lisar_side}
            {MODIFY_SIDE_AI (2) (
                [avoid]
                    {WELDYN_MOAT_SLF}
                [/avoid]
            )}
        )}
        
        #------------------------
        # IF DEFENDING...
        #------------------------
        {ELSE(
            {RESET_SIDE_AI 2 offensive 0.2 0.8}
            
            #
            # for each manually determined guard hex (including ones resulting from {WELDYN_SECTOR_AVOID})...
            #   create goal with value of:
            #      {VALUE} * (0.5 + (radius-6 levels + radius-10 levels) / weldyn-center-15 levels ) 
            #      i.e. if 100% of Konrad's nearby army is 0-6  hexes away, x2.5 our base {VALUE}
            #      i.e. if 100% of Konrad's nearby army is 7-10 hexes away, x1.5 our base {VALUE}
            #      i.e. if  50% of Konrad's nearby army is 0-6  hexes away, x1.5 our base {VALUE}
            #      i.e. if  50% of Konrad's nearby army is 7-10 hexes away, x1.0 our base {VALUE}
            #      i.e. if   0% of Konrad's nearby army is 0-10 hexes away, x0.5 our base {VALUE}
            #
            
            
            
            
            
            
            # determine which (if any) quadrants to avoid
            # {WELDYN_SECTOR_AVOID} will clear these variables if the area is safe to enter
            {VARIABLE avoidEastX "22"}
            {VARIABLE avoidEastY ""}
            {WELDYN_SECTOR_AVOID avoidEastX avoidEastY (
                # TODO - how do I reconcile these goals with the overlaps?
                {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 (x,y=16,13)})}
            )}
            
            
            
            
            
            
            
            
            
            
            
            
            # give hexes a small score bonus depending on how many (and how powerful) enemy units can reach those hexes
            # do this so that we prefer defending the walls on the side(s) that actually have enemies
            [store_units]
                {FILTER side=1,$lisar_side}
                variable=stored_enemies
            [/store_units]
            [foreach]
                array=stored_enemies
                variable=unit
                [do]
                    [store_reachable_locations]
                        {FILTER id=$unit.id}
                        range=attack # this DOES include ZoC. Hopefully results in us putting lots of guards on the walls/borders/etc
                        variable=locations
                    [/store_reachable_locations]
                    [foreach]
                        array=locations
                        variable=loc
                        [do]
                            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION "$( $unit.level / 30 )" x,y,radius=$unit.x,$unit.y,5})}
                        [/do]
                    [/foreach]
                [/do]
            [/foreach]
            
            
            # outer wall goals: east
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=24,20})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=25,21})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=25,22})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=25,23})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=24,23})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=25,26})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=23,26})}
            
            # outer wall goals: northeast
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=23,18})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=21,17})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=20,17})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=23,18})}
            
            # outer wall goals: northwest
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=17,17})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=16,16})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=14,17})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=14,18})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 4 x,y=12,18})}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=11,20})}
            
            # outer wall goals: west
            
            
            
            

            
            
            
            
            
            
            
            
            
            
            
            
            # set avoid aspect
            {MODIFY_SIDE_AI (2) (
                [avoid]
                    x,y=0,0
                    
                    # avoid any areas
                    [or]
                        x=$avoidEastX
                        y=$avoidEastY
                    [/or]
                    
                    
                    # avoid a ring around Weldyn. Prevent a 7mp quick Royal Guard from leaving,
                    # but allow 8+ mp scouts to escape and cap villages, even now that we're defensive
                    [or]
                        {AND x,y,radius=18,22,14}
                        {NOT x,y,radius=18,22,7}
                    [/or]
                    
                    # always avoid the moat
                    {OR({WELDYN_MOAT_SLF})}
                [/avoid]
            )}
            
#             if any units are in the avoid area, retreat them towards Weldyn (until they're no longer in the avoid area)
#                 I think I can use the coward MAI for this
            
        )} [/if]
    [/event]



#         ----Auxiliaries:
#         standard attack/retreat logic
#         hardcode retreat locations based on which leaders are surviving
#             make sure not to block keepsModa
# 
# 
#         ----Reinforcements:
#         if within 2 turns of $most_recent_arrival_turn
#             AND if enemies are near our spawn location
#             be aggressive
# 
#         otherwise, standard vary by schedule logic
#             no retreat option. Too complex with the number of sides that might be fighting
#         
#         also avoid weldyn moat
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   LISAR SIDE & EVENTS
    #######################################################################################################################################################
    {LISAR_SIDE 6
        (RECRUIT=Shock Trooper,Longbowman,Duelist)
        (INCOME={ON_DIFFICULTY4 10 16 22 28}) # extra base income for the finale (which might still be doubled if we did Cliffs of Thoria)
    }                                         # a player who's manually controlling Li'sar won't benefit, but I expect them to have built up veterans by now instead
    {LISAR_CHOOSE_CONTROLLER
        (IF_AI_CONTROL=
            {SILENTLY_LIMIT_LEADER_MOVES $lisar_side 3}
        )
    }
#     [event]
#         name=side $lisar_side turn
#         first_time_only=no
#         {RESET_SIDE_AI $lisar_side offensive 0.4 0.25}
#         {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME $lisar_side 2,3,4,5}
#         {MODIFY_AI_ADD_GOAL $lisar_side ({GOAL_SEEK_SIDE  4 0.5 0})} # prefer attacking the southwest (closest) enemy leader
#         {RETREAT_WHEN_WEAK $lisar_side {ON_DIFFICULTY4 0-3 0-4 0-5 0-5} (
#             {GOAL_LOCATION 2 x,y=30,23}
#             {GOAL_LOCATION 2 x,y=29,25}
#             {GOAL_LOCATION 1 x,y=29,24}
#         )}
#         
#     [/event]
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        #############################
        # TERRAIN
        #############################
        {PLACE_IMAGE items/dwarven-keep-tile.png 28 11}
        {BRAZIER_DYNAMIC_DAY 2 7 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 6 5 OFFSET={TOD_OFFSET}}
        
        #############################
        # DAN'TONK GUARDS
        #############################
        {UNSTORE_NPC Isolde x,y=11,8 side,facing=2,se}
        
        # these guys don't oppose the player; keep them the same on all difficulties
        {GENERIC_UNIT 2 Longbowman 2 6} {FACING se} {ZONE_GUARDIAN 2 6 x,y,radius=4,4,4} {ROLE city_guard}
        {GENERIC_UNIT 2 Javelineer 4 4} {FACING se} {ZONE_GUARDIAN 4 4 x,y,radius=4,4,4} {ROLE city_guard}
        {GENERIC_UNIT 2 Spearman   4 7} {FACING se} {ZONE_GUARDIAN 4 7 x,y,radius=4,4,5} {ROLE city_guard}
        {GENERIC_UNIT 2 Spearman   7 6} {FACING se} {ZONE_GUARDIAN 7 6 x,y,radius=4,4,5} {ROLE city_guard}
        
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "Spearman"   "Spearman"   "Javelineer"}) 12  8 ({FACING se}{ZONE_GUARDIAN 12  8 x,y,radius=11,8,2})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "Spearman"   "Spearman"   "Spearman"  }) 19  8 ({FACING se}{ZONE_GUARDIAN 19  8 x,y,radius=16,7,3})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none"       "Spearman"   "Spearman"  }) 16  9 ({FACING sw}{ZONE_GUARDIAN 16  9 x,y,radius=17,7,3})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none"       "none"       "Bowman"    }) 21  7 ({FACING se}{ZONE_GUARDIAN 21  7 x,y,radius=20,6,2})}
        
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none" "Spearman"   "Spearman"   "Spearman"  }) 28  2 ({FACING se}{ZONE_GUARDIAN 28  2 x,y,radius=28,1,3})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none" "none"       "Spearman"   "Spearman"  }) 33  3 ({FACING sw}{ZONE_GUARDIAN 33  3 x,y,radius=31,2,3})}
        
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none" "Spearman"   "Spearman"   "Javelineer"}) 11 13 ({FACING se}{ZONE_GUARDIAN 11 13 x,y,radius=9,12,3})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none" "none"       "Spearman"   "Spearman"  }) 8  14 ({FACING sw}{ZONE_GUARDIAN 8  14 x,y,radius=8,14,3})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none" "Spearman"   "Spearman"   "Spearman"  }) 3  14 ({FACING se}{ZONE_GUARDIAN 3  14 x,y,radius=6,13,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none" "none"       "Spearman"   "Spearman"  }) 1  16 ({FACING se}{GUARDIAN})}
        
        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SCROLL_TO 86 21}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # KONRAD ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Konrad      35 25} {MODIFY_UNIT id=Konrad facing nw}
        {RECALL_XY Delfador    36 24} {MODIFY_UNIT id=Delfador facing nw}
        {UNSTORE_NPC Lisar x,y=34,25 side=$lisar_side} {MODIFY_UNIT id=Lisar facing nw}
        {DELAY 250}
        
        #############################
        # SPEAKING WITH ISOLDE
        #############################
        [message]
            speaker=Lisar
            message= _ "Hello, Isolde. I see my mother’s appointed you regent in Dan’Tonk — congratulations. We were comrades, once. I’m sorry we now find ourselves on opposing sides."
        [/message]
        [message]
            speaker=Isolde
            message= _ "Hello, Li’sar. I’m sorry too. I never saw you as one to turn against your sovereign; your own kin. ...I suppose it runs in the family."
        [/message]
        [message]
            speaker=Konrad
            message= _ "You are bold to march out from behind your walls and meet us on the open plain. Are you not worried we will defeat you?"
        [/message]
        [message]
            speaker=Isolde
            message= _ "Hmph. My whole life, I’ve wanted to live a peaceful life. But there’s always someone causing problems. First it was Garard, then the baron. Outlaws on the isles, elves in the Aethenwood. Always one more thing."
        [/message]
        [message]
            speaker=Isolde
            message= _ "And now it’s you three. At least you had the coutesy to come to my city — your queen’s city — in person. I can vanquish you and your armies all at once."
        [/message]
        
        #############################
        # KONRAD SETS UP KEEP
        #############################
        {MOVE_UNIT id=Konrad 35 23}
        {MODIFY_TERRAIN Ke 35 23} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 34 22} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 35 22} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 36 22} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 36 23} {REDRAW} {DELAY 150}
        {RECALL_KONRAD_AND_COMPANIONS 35 23}
        
        #############################
        # LISAR SETS UP KEEP
        #############################
        {MOVE_UNIT id=Lisar 30 24}
        {MODIFY_TERRAIN Ke 30 24} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 30 23} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 31 24} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 30 25} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 29 25} {REDRAW} {DELAY 150}
        {WARVEN_OR_GUARD "Heavy Infantryman" 31 24 nw x,y,radius=34,25,4}
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Isolde"
                condition=win
            [/objective]
            [objective]
                {ALTERNATIVE_OBJECTIVE_CAPTION}
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            [note]
                description= _"Gryphons will appear periodically near the northwest corner of the map. They aren’t your allies, but will prefer to attack Isolde’s soldiers when given the choice."
                [show_if]
                    {HAVE_UNIT side=5}
                [/show_if]
            [/note]
        [/objectives]
    [/event]
    
    #############################
    # GRYPHONS ARRIVE
    #############################
    [event]
        name=side 5 turn 2
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_s14_gryphons_survived equals yes})}
        {GENERIC_UNIT 5 ({ON_DIFFICULTY4 Gryphlet Gryphlet Gryphon  Gryphon}) 7 1} {FACING se} {ANIMATE}
        {GENERIC_UNIT 5 ({ON_DIFFICULTY4 Gryphlet Gryphon  Gryphon  Gryphon}) 3 1} {FACING se} {ANIMATE}
        {GENERIC_UNIT 5 ({ON_DIFFICULTY4 Gryphlet Gryphlet Gryphlet Gryphon}) 1 6} {FACING se} {ANIMATE}
        [message]
            side=5
            message= _ "Kraww!!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION glad}
            message= _ "Look, gryphons are attacking soldiers inside the city walls!"
        [/message]
        [message]
            speaker=Isolde
            message= _ "These vermin again. What did that dwarf do to rile them up so badly?!"
        [/message]
        [message]
            speaker=Konrad
            message= _ "I suspect they have a particular grudge against the soldiers of Dan’Tonk, but we should still do our best to stay our of their way — they remain wild animals."
        [/message]
        {ACHIEVE s48}
        [show_objectives]
        [/show_objectives]
        
        #------------------------
        # SPAWN GRYPHONES PERIODICALLY
        #------------------------
        [event]
            name=new turn
            first_time_only=no
            {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_s14_gryphons_survived equals yes})}
            {FILTER_CONDITION({LUA "return (wesnoth.current.turn%4==0)"})}
            [random_placement]
                {FILTER_LOCATION( x,y=1,1-18 {OR x,y=1-25,1} )}
                num_items={ON_DIFFICULTY4 2 3 3 4}
                min_distance=1
                variable=hex
                [command]
                    {VARIABLE_OP unit_type rand ({ON_DIFFICULTY4
                        Gryphlet,Gryphlet,Gryphlet,Gryphon
                        Gryphlet,Gryphlet,Gryphlet,Gryphon
                        Gryphlet,Gryphon,Gryphon,Gryphon
                        Gryphlet,Gryphon,Gryphon,Gryphon
                    })}
                    {GENERIC_UNIT 5 $unit_type $hex.x $hex.y} {ANIMATE} {FACING se}
                    {CLEAR_VARIABLE unit_type}
                [/command]
            [/random_placement]
        [/event]
    [/event]

    
    
    #############################
    # EXPLAIN BONUS OBJECTIVE
    #############################
    [event]
        name=turn 4
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message= _ "Li’sar, as a general of Wesnoth you were surely familiar with Dan’Tonk’s defenses. Do you have any insight into its weaknesses? Is there anything we can use against the general?"
        [/message]
        [message]
            speaker=Lisar
            #po: reference to Asheviere's Dogs
            message= _ "There was a hidden tunnel, once, but I had it collapsed some years ago. Sorry."
        [/message]
    [/event]
    
    #############################
    # SMALLTALK
    #############################
    [event]
        name=turn 7
        {FIRE_EVENT say_smalltalk}
    [/event]
    
    #############################
    # DELFADOR ATTACKS ISOLDE
    #############################
    [event]
        name=attack
        {FILTER id=Delfador}
        [event]
            name=attack
            {FILTER id=Delfador}
            [event]
                name=attack
                {FILTER id=Delfador}
                [event]
                    name=attack
                    {FILTER id=Delfador}
                    [message]
                        speaker=Delfador {DELFADOR_VARIATION mad}
                        message= _ "I have not forgotten your part in the fall of Dan’Tonk, general Isolde. I will avenge the baron’s death!"
                    [/message]
                [/event]
            [/event]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # VICTORY
    #############################
    [event]
        name=last breath
        {FILTER id=Isolde}
        
        [modify_unit]
            {FILTER id=$second_unit}
            experience="$( $this_unit.experience + 24 )" # manually award XP to whoever killed Isolde, since she flees as part of the cutscene, which breaks the normal death event
        [/modify_unit]
        [message]
            speaker=Isolde
            message= _ "Argh! This is going terribly. Retreat! Retreat!"
        [/message]
        {FIRE_EVENT victory_cutscene}
    [/event]
    [event]
        name=victory_cutscene
        #------------------------
        # ISOLDE FLEES
        #------------------------
        {TELEPORT_UNIT (side=1,$lisar_side {FILTER_LOCATION x,y,radius=1,3,7}) 34 23}
        {MOVE_UNIT id=Isolde 1 5}
        {STORE_NPC Isolde}
        {MODIFY_UNIT role=city_guard side 5} # so that they don't move - they're already inside the city
        {CUTSCENE_ENEMIES_RETREAT 2,3,4  1..7 1..6  (AFTER_RETREAT=)}
        {MODIFY_TERRAIN Rr^Pr/ 5 8}
        {MODIFY_TERRAIN Rr^Pr/ 6 7}
        {MODIFY_TERRAIN Rr^Pr/ 7 7}
        {SOUND gate-fall.ogg}
        {REDRAW}
        
        #------------------------
        # DISCUSSING VICTORY
        #------------------------
        [message]
            speaker=Delfador
            message= _ "Victory is won. As we expected, Isolde has taken refuge behind the city walls. We’ve defeated her army, but it has not been broken. And we lack the supplies or time to besiege the city proper."
        [/message]
        [message]
            speaker=Konrad
            message= _ "Maybe we don’t need to, Delfador. Power is a fragile thing, and we’ve shown this entire city — a city that once fought against Asheviere — that the queen is not so unbeatable as she once seemed. I do not think Isolde will be able to leave Dan’Tonk again without risking its revolt."
        [/message]
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message= _ "That, and also I’ll leave a few of my men behind to destroy the roads and harass any sorties. Dan’Tonk won’t pose any problem when we attack Weldyn."
        [/message]
        
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
#undef TOD_OFFSET
#undef WELDYN_MOAT_SLF
#undef WELDYN_SECTOR_AVOID
