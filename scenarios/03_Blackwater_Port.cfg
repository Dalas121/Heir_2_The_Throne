#textdomain wesnoth-httt
    
#TODO: adjust unit locations, captured villages, etc. for everyone based on new map coordinates after map is changed
 #UPD: most of the coordinates have been changed, except horsemen at the end

[scenario]
    id=03_Blackwater_Port
    name= _ "scenario name^Blackwater Port"
    next_scenario=00_The_Great_Continent
    map_file=03_Blackwater_Port.map
    {SCHEDULE_DYNAMIC $current_time}
    turns={ON_DIFFICULTY4 12 12 12 12}

    {SCENARIO_MUSIC "loyalists.ogg"}
    {EXTRA_SCENARIO_MUSIC "knolls.ogg"}
    {EXTRA_SCENARIO_MUSIC "breaking_the_chains.ogg"}
    {EXTRA_SCENARIO_MUSIC "wanderer.ogg"}
    {EXTRA_SCENARIO_MUSIC "battle.ogg"}

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Resist until the end of the turns"
                condition=win
                show_turn_counter=yes
            [/objective]
            [objective]
                {BONUS_OBJECTIVE_CAPTION}
                description= _ "Protect Sir Kaylan (to get full scenario reward.)"
                [show_if] {HAVE_UNIT id=Kaylan} [/show_if]
                condition=win
            [/objective]
#ifdef HARD
            [objective]
                {ALTERNATIVE_OBJECTIVE_CAPTION}
                description= _ "Defeat the enemy leaders"+{EARLY_FINISH_BONUS_FOOTNOTE}+{OBJECTIVE_FOOTNOTE _"(special bonus)"}
                condition=win
            [/objective]
#else
            {ALTERNATIVE_OBJECTIVE_BONUS ( _ "Defeat the enemy leaders")}
#endif
            [objective]
                description= _ "Death of Konrad"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            [gold_carryover]
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"If Sir Kaylan dies, you will not get Horsemen and Cavalrymen, only Peasants and Woodsmen."
            [/note]
        [/objectives]
    [/event]

    #TODO: uncomment the story text when the actual story gets added

    #{HTTT_TRACK {JOURNEY_02_NEW} }

    {KONRAD_SIDE {ON_DIFFICULTY4 100 80 65 50}}

    [side]
        type=Grand Knight
        id=Kaylan
        name= _ "Sir Kaylan"
        profile=portraits/humans/grand-knight-2.webp

        side=2
        # Make Kaylan's TC teal, so it fits better with the portrait.
        color=teal
        canrecruit=yes
        team_name=konrad
        user_team_name=_"Rebels"
        recruit=Horseman
        [ai]
            recruitment_pattern=fighter
            villages_per_scout=0
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            aggression=0.45
            grouping=defensive
        [/ai]
        gold,income={ON_DIFFICULTY4 40 60 80 100},0
    [/side]
    #Kaylan can move 2 tiles per turn, not too fast but not completely immobile
    {SILENTLY_LIMIT_LEADER_MOVES 2 2}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Knight" 1}

    {STARTING_VILLAGES_AREA 2 12 8 5}

    [side]
        type=Lieutenant
        #TODO: maybe add some name to the enemy leader?
        id=enemy1
        name= _ "TODOius the Unfinished"
        side=3
        color=purple
        canrecruit=yes
        team_name=enemies
        user_team_name=_"Army of Wesnoth"
        recruit=Spearman,Bowman,Cavalryman
        gold,income={ON_DIFFICULTY4 40 60 80 100},{ON_DIFFICULTY4 -2 0 2 4}
        {FLAG_VARIANT loyalist}
    [/side]
    #lieutenant enemy is pretty fragile, so only 1 move per turn
    {SILENTLY_LIMIT_LEADER_MOVES 3 1}

    {STARTING_VILLAGES_AREA 3 29 7 5}

    [side]
        type=Pikeman
        #TODO: maybe add some name to the enemy leader?
        id=enemy2
        name= _ "TODOius the Unfinished"
        side=4
        color=purple
        canrecruit=yes
        team_name=enemies
        user_team_name=_"Army of Wesnoth"
        recruit=Spearman,Bowman,Cavalryman
        gold,income={ON_DIFFICULTY4 40 60 80 100},{ON_DIFFICULTY4 -2 0 2 4}
        {FLAG_VARIANT loyalist}
    [/side]
    #pikeman only moves up to 2 tiles to heal in village/attack if necessary
    {SILENTLY_LIMIT_LEADER_MOVES 4 2}

    {STARTING_VILLAGES_AREA 4 21 14 2}

    [side]
        type=Orcish Warrior
        id=Mokolo Qimur
        name= _ "Mokolo Qimur"
        profile=portraits/orcs/grunt-2.webp
        side=5
        color=black
        canrecruit=yes
        team_name=enemies
        user_team_name=_"Blackcrest Clan"
        recruit=Orcish Grunt,Orcish Archer,Troll Whelp
        #note: when balancing gold, keep in mind orcs arrive towards Kaylan's troops when it's nighttime, so they have an advantage compared to loyalists
        gold,income={ON_DIFFICULTY4 30 45 60 75},{ON_DIFFICULTY4 -2 0 2 4}
        {FLAG_VARIANT6 ragged}
    [/side]

    #orcs are too far to really need a silently_limit_leader macro, and the leader can just be more aggressive than average anyway

    {STARTING_VILLAGES_AREA 5 1 18 7}

    [event]
        name=prestart

        {PLACE_IMAGE items/dwarven-keep-tile.png 29 7}

        {BRAIZER_DYNAMIC 10 7 $current_time}
        {BRAIZER_DYNAMIC 8 10 $current_time}
        {BRAIZER_DYNAMIC 15 10 $current_time}
        {BRAIZER_DYNAMIC 26 8 $current_time}

        {GENERIC_UNIT 2 (Spearman) 18 11} {FACING se} {GENDER male} {ZONE_GUARDIAN 18 11 x,y,radius=12,8,7}
        {GENERIC_UNIT 2 (Spearman) 14 12} {FACING se} {GENDER male} {ZONE_GUARDIAN 14 12 x,y,radius=12,8,7}
        {GENERIC_UNIT 2 (Spearman) 10 11} {FACING sw} {GENDER male} {ZONE_GUARDIAN 10 11 x,y,radius=12,8,7}

        {GENERIC_UNIT 3 (Spearman) 23 10} {FACING sw} {GENDER male} {ZONE_GUARDIAN 23 10 x,y,radius=29,7,7}
        {GENERIC_UNIT 3 (Shock Trooper) 27 10} {FACING sw} {GENDER male} {ZONE_GUARDIAN 27 10 x,y,radius=29,7,5}

        #make AI prioritize Kaylan instead of Konrad first

        {MODIFY_AI_ADD_GOAL 3 (
            {GOAL_SEEK_SIDE 20 2 0}
        )}

        {MODIFY_AI_ADD_GOAL 4 (
            {GOAL_SEEK_SIDE 20 2 0}
        )}

        {RECALL_KONRAD_AND_COMPANIONS 33 20}
    [/event]

    [event]
        name=start
        [if] {HAVE_UNIT id=Delfador} {THEN(

        #TODO: rewrite this later, it's mostly the old dialog right now:

        [message]
            speaker=Delfador
            message= _ "We should be able to board a ship at Blackwater Port, but it seems the orcs are heading there too. Rebels who hate Asheviere and are loyal to the memory of the king desperately hold the port, as it is one of the only places where they can ship supplies and weapons."
        [/message]
        [message]
            speaker=Konrad
            message= _ "Mister Delfador, I hope some orcs are following us! We must make haste!"
        [/message]
        [message]
            speaker=Kaylan
            message= _ "Delfador, my old friend! We had heard of your coming, and of the attacks on the elves. It is good to see you again, although I would prefer it were not in such sad times."
        [/message]
        [message]
            speaker=Delfador
            message= _ "Konrad, this is Kaylan, one of the mightiest of the horse lords, and one of the few who is willing to oppose the Dark Crown. Rumor has it that his lance has slain a hundred men and fifty orcs."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "It seems the orcs have come here too, to try to wrest this port from our hands. Our defenses are still weak, but reinforcements will arrive soon!"
        [/message]
        [message]
            speaker=Konrad
            message= _ "We will help you fight them off until the reinforcements arrive."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "With your help, we have hope we can fend them off. But you must not tarry here long, for your survival is even more important to our cause than the strength of the port. A ship is due here in two days, surely it will be able to take you to safety."
        [/message]
        [message]
            speaker=Konrad
            message= _ "And the ship will take us to Alduin?"
        [/message]
        [message]
            speaker=Delfador
            message= _ "Yes, we will sail to the Isle of Alduin, my home, Konrad, and the home of many magi."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "I will send one of my horsemen to serve under you. I offer you my support, Konrad, and the support of my men — from now on you will be able to recruit horsemen."
        [/message]
        #   [message]
        #   speaker=narrator
        #   image="wesnoth-icon.png"
        #   message= _ "You may now recruit horsemen!"
        #   [/message]
        [message]
            speaker=Konrad
            message= _ "Thank you, sir. But how shall I best use these horsemen? How do they differ from elves?"
        [/message]


        [message]
            speaker=Delfador
            message= _ "TODO"
        [/message]

        #giving the player a peasant that is close to leveling, with good traits to be a spearman

        [unit]
            type=Peasant
            x=31
            y=17
            id=s3_peasant
            name= _ "TODOius the Unfinished"
            side=1
            experience=11
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        #TODO: peasant dialog:

        [message]
            speaker=s3_peasant
            message= _ "TODO"
        [/message]

        [message]
            speaker=narrator
            message= _ "You can now recruit Peasants and Woodsmen."
        [/message]
        #Blackwater Port early reward, regardless of outcome
        [allow_recruit]
            side=1
            type=Peasant,Woodsman
        [/allow_recruit]

        )}
        {ELSE(

        [message]
            speaker=Konrad
            message= _ "TODO"
        [/message]

        )}[/if]

    [/event]

    #old dialog to use as a reference:

    [event]
#        name=start
        name=start_unused
        [message]
            speaker=Delfador
            message= _ "We should be able to board a ship at Blackwater Port, but it seems the orcs are heading there too. Rebels who hate Asheviere and are loyal to the memory of the king desperately hold the port, as it is one of the only places where they can ship supplies and weapons."
        [/message]
        [message]
            speaker=Konrad
            message= _ "Delfador, some orcs are following us! We must make haste!"
        [/message]
        [message]
            speaker=Kaylan
            message= _ "Delfador, my old friend! We had heard of your coming, and of the attacks on the elves. It is good to see you again, although I would prefer it were not in such sad times."
        [/message]
        [message]
            speaker=Delfador
            message= _ "Konrad, this is Kaylan, one of the mightiest of the horse lords, and one of the few who is willing to oppose the Dark Crown. Rumor has it that his lance has slain fifty men and a hundred orcs."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "It seems the orcs have come here too, to try to wrest this port from our hands. Our defenses are still weak, but reinforcements will arrive soon!"
        [/message]
        [message]
            speaker=Konrad
            message= _ "We will help you fight them off until the reinforcements arrive."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "With your help, we have hope we can fend them off. But you must not tarry here long, for your survival is even more important to our cause than the strength of the port. A ship is due here in two days, surely it will be able to take you to safety."
        [/message]
        [message]
            speaker=Konrad
            message= _ "And the ship will take us to Alduin?"
        [/message]
        [message]
            speaker=Delfador
            message= _ "Yes, we will sail to the Isle of Alduin, my home, Konrad, and the home of many magi."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "I will send one of my horsemen to serve under you. I offer you my support, Konrad, and the support of my men — from now on you will be able to recruit horsemen."
        [/message]
        #   [message]
        #   speaker=narrator
        #   image="wesnoth-icon.png"
        #   message= _ "You may now recruit horsemen!"
        #   [/message]
        [message]
            speaker=Konrad
            message= _ "Thank you, sir. But how shall I best use these horsemen? How do they differ from elves?"
        [/message]
#ifdef EASY
        [message]
            speaker=Kaylan
            message= _ "Elves are a powerful race, Konrad, more powerful than my own people usually acknowledge. But horsemen are powerful in a different way. They have no long range attack, but can charge into combat, inflicting double normal damage, though taking double damage in return. They are also lawful, meaning they fight better by day, and worse at night. Horsemen are unmatched on open land, though elves will serve you better in forests or rugged terrain."
        [/message]
#else
        [message]
            speaker=Kaylan
            message= _ "Elves may be the lords of the forest, but horsemen are powerful as well. On the plains under the midday sun they can fell the toughest foes with sharp spears and under heavy hoofs!"
        [/message]
#endif
        [message]
            speaker=Delfador
            {DELFADOR_MENTORING_ELF}
            message= _ "Recruit troops wisely, Konrad, and remember that you can recall experienced units from past battles to help you fight again."
        [/message]
        [move_unit_fake]
            side=1
            type=Horseman
            x=15,16,23
            y=27,27,24
        [/move_unit_fake]
        [unit]
            id=Haldiel
            name= _ "Haldiel"
            type=Horseman
            x=23
            y=24
            side=1
            facing=ne
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]
        [message]
            speaker=Haldiel
            message= _ "Greetings, young master. I pledge myself to your service."
        [/message]
        [message]
            speaker=Delfador
            {DELFADOR_MENTORING_ELF}
            message= _ "Konrad, note that Haldiel does not seek gold upkeep; as a loyal unit he fights for us solely out of loyalty to our cause. Such units are extremely valuable. Take care to use them cautiously in battle, lest they fall."
        [/message]
    [/event]


    [event]
        name=attack end
        [filter_second]
            id=Kaylan
        [/filter_second]

        [message]
            speaker=Kaylan
            message= _ "Asheviere's troops are breaking through our defenses! Veocyn, Yran, hold the line!"
        [/message]

        [unit]
            type=Swordsman
            x=$unit.x
            y=$unit.y
            id=Veocyn
            name= _ "Veocyn"
            side=2
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Swordsman
            x=$unit.x
            y=$unit.y
            id=Yran
            name= _ "Yran"
            side=2
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [message]
            speaker=Veocyn
            message= _ "Sir yes sir!"
        [/message]
    [/event]

    #note: should be close to when the turns run out, a small group of reinforcements arrives early:

    [event]
        name=turn 10
        [scroll_to]
            x=20
            y=20
        [/scroll_to]
        [unit]
            type=Horseman
            id=Vygwyn
            name= _ "Vygwyn"
            x=18
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Cavalryman
            id=Gaebryn
            name= _ "Gaebryn"
            x=20
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [message]
            speaker=Vygwyn
            message= _ "TODO: dialog about how the rest of the reinforcements will arrive soon"
        [/message]
    [/event]

    [event]
        name=time over
        [scroll_to]
            x=20
            y=20
        [/scroll_to]
        [unit]
            type=Horseman
            id=Yredd
            name= _ "Yredd"
            x=16
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Dragoon
            id=Tarcyn
            name= _ "Tarcyn"
            x=20
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Horseman
            id=Syryn
            name= _ "Syryn"
            x=24
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Knight
            id=Cicyn
            name= _ "Cicyn"
            x=21
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Knight
            id=Ginvan
            name= _ "Ginvan"
            x=17
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Knight
            id=Simyr
            name= _ "Simyr"
            x=23
            y=20
            side=2
            facing=ne
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        [message]
            speaker=Kaylan
            message= _ "Reinforcements have arrived! Forward, men! I expect each of you to bring me back the head of an orc!"
        [/message]
        [message]
            speaker=Mokolo Qimur
            message= _ "So many foul humans riding on horses! There is no way we can defeat them. Quick, we must make our escape!"
        [/message]
        [fire_event]
            name=victory dance
        [/fire_event]
        [endlevel]
            result=victory
            bonus=no
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    [event]
        name=die
        [filter]
            id=Mokolo Qimur
        [/filter]

        #
        # A bonus for anyone who can beat the leader on the HARD level
        #
#ifdef HARD
        [scroll_to]
            x=35
            y=6
        [/scroll_to]
        [unit]
            type=Horseman
            id=Yredd
            name= _ "Yredd"
            x=35
            y=6
            ai_special=guardian
            side=2
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Horseman
            id=Tarcyn
            name= _ "Tarcyn"
            x=35
            y=6
            ai_special=guardian
            side=2
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Horseman
            id=Syryn
            name= _ "Syryn"
            x=35
            y=6
            ai_special=guardian
            side=2
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Knight
            id=Cicyn
            name= _ "Cicyn"
            x=35
            y=6
            ai_special=guardian
            side=2
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Knight
            id=Ginvan
            name= _ "Ginvan"
            x=35
            y=6
            ai_special=guardian
            side=2
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type=Knight
            id=Simyr
            name= _ "Simyr"
            x=35
            y=6
            ai_special=guardian
            side=2
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        [redraw]
        [/redraw]
        [message]
            speaker=Kaylan
            message= _ "Reinforcements have arrived, but lo! Our allies have already destroyed the orcish army menacing our fair port. In honor, I must reward your valor."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "You have risked your life to defend our city. In return, I place one of my city’s finest defenders in your service. Simyr, step forward. I place your lance in the service of young Prince Konrad here. May you help him restore order to the country."
        [/message]
        [kill]
            id=Simyr
        [/kill]
        [move_unit_fake]
            side=2
            type=Knight
            x=33,29
            y=5,7
        [/move_unit_fake]
        [unit]
            type=Knight
            id=Simyr
            name= _ "Simyr"
            x=29
            y=7
            side=1
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        [message]
            speaker=Simyr
            message= _ "It is my pleasure and honor to serve, my liege."
        [/message]
#endif

        [fire_event]
            name=victory dance
        [/fire_event]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    [event]
        name=victory dance

        [if]
        {VARIABLE_CONDITIONAL bm_kaylan_dead equals yes}
        [then]
        [message]
            speaker,image=Konrad,portraits/konrad-elvish-concerned.webp
            message=_"TODO: sad dialog about Kaylan's death"
        [/message]
        [/then]
        [else]
        [message]
            speaker=Kaylan
            message= _ "Thank you for the help, friends. With the port liberated, you can now reach Alduin."
        [/message]
        [message]
            speaker=Delfador
            message= _ "We should embark soon."
        [/message]
        [message]
            speaker=Kaylan
            message= _ "Safe voyage to you, friends. Rest assured that we will never surrender to the forces of the Dark Queen."
        [/message]

        #Blackwater Port reward:
        [message]
            speaker=narrator
            message= _ "You can now recruit Horsemen and Cavalrymen."
        [/message]
        [allow_recruit]
            side=1
            type=Horseman,Cavalryman
        [/allow_recruit]
        [/else]
        [/if]
    [/event]

    #
    # Death event for Sir Kaylan
    #
    [event]
        name=last breath
        [filter]
            id=Kaylan
        [/filter]
        [message]
            speaker=unit
            message= _ "I have failed in my duty to protect the Rightful Heir and the port."
        [/message]

        [if] {HAVE_UNIT id=Delfador} {THEN(

        [message]
            speaker=Delfador
            message= _ "TODO"
        [/message]

        )}
        {ELSE(

        [message]
            speaker=Konrad
            message= _ "TODO"
        [/message]

        )}[/if]

        {VARIABLE bm_kaylan_dead yes}

    [/event]
[/scenario]
