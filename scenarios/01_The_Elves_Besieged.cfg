#textdomain wesnoth-h2tt
# scenario by Dalas

[scenario]
    id,map_file,name=01_The_Elves_Besieged,01_The_Elves_Besieged.map,_"The Elves Besieged"
    next_scenario,victory_when_enemies_defeated=00_The_Great_Continent,no
    {DEFAULT_SCHEDULE} # dawn, thus why konrad is sleeping
                       # if I change the initial `current_time`, remember to change IMPLEMENT_FIRES too
    turns=-1
          {SCENARIO_MUSIC wanderer.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}
    
    
    # prepare NPCs. The NPCs created here are stored and reused for every scenario in this campaign
    [event]
        name=prestart
        {FIRE_EVENT spawn_npcs}
    [/event]
    
    
    
    #######################################################################################################################################################
    #                                                                    HTTT INTRO
    #######################################################################################################################################################
    [story]
        [part]
            music=revelation.ogg
            story= _ "In the twenty-eighth year of the reign of Garard II, King of Wesnoth, the kingdom was plunged into a bitter war with the Orcs of the North."
            {HTTT_BIGMAP}
        [/part]
        [part]
            # wmllint: local spelling Galcadar
            story= _ "The Northern host encamped at Galcadar, by the Ford of Abez, and the King led his forces to meet them. Years of war brought Wesnoth to the brink of ruin, but at long last victory was won through the actions of Garard’s arch-mage, Delfador."
            {HTTT_BIGMAP}
        [/part]
        [part]
            story= _ "Garard’s son, the Crown Prince Eldred, joined in the revelry as the King celebrated his victory. Eldred was bright and driven, and might one day have grown into a wise ruler. Unfortunately for Garard, his son was also ambitious... and treacherous."
            background=story/httt_story1.webp
        [/part]
        [part]
            story= _ "At the height of Garard’s triumph, Eldred struck the old King down in cold blood. Proclaiming himself heir, the young prince led his father’s army south towards Weldyn."
            background=story/httt_story2.webp
        [/part]
        [part]
            story= _ "Garard’s queen, Asheviere, looked on with glee, having orchestrated much of her son’s treachery. The rule of Eldred would surely satisfy her lust for power far better than her husband’s had."
            background=story/httt_story3.webp
        [/part]
        [part]
            story= _ "But Delfador the arch-mage had not fallen alongside his king. Returning from a distant battle, he mustered a force of loyalists to fight the young prince and avenge the King’s death. The loyalist army marched south to meet Eldred."
            background=story/httt_story4.webp
        [/part]
        [part]
            story= _ "Eldred made war upon the loyalists with his mother’s advice ringing in his ears: <i>“Fight no one great or small except the old mage, whose head should be severed from his shoulders.”</i>"
            {HTTT_BIGMAP}
        [/part]
        [part]
            story= _ "And Eldred did indeed meet Delfador face-to-face in battle, along the high road to Weldyn. Sword clashed against staff, as the wise old mage fought the brash young warrior."
            background=story/httt_story5.webp
        [/part]
        [part]
            story= _ "In the end Delfador’s men were defeated and routed, but Asheviere found her son’s lifeless body, fixed to the ground by the great mage’s staff."
            background=story/httt_story6.webp
        [/part]
        [part]
            story= _ "Asheviere herself then took command of the army and led it back to Weldyn. Knowing that the King’s young nephews were next in line to the throne, she ordered them all killed, and declared herself Queen of Wesnoth."
            {HTTT_BIGMAP}
        [/part]
        [part]
            story= _ "Soon after news of Asheviere’s orders reached Delfador, he secretly entered the palace and stole away Konrad, the youngest of Garard’s nephews, thereby saving him from death."
            background=story/httt_story7.webp
        [/part]
        [part]
            story= _ "Fleeing to the Aethenwood beyond the south-western border of Wesnoth, Delfador raised the child Konrad under the protection of the elves, watching sadly as Asheviere’s reign of terror over the land began..."
            background=story/httt_story8.webp
        [/part]
    [/story]
    
    
    #######################################################################################################################################################
    #                                                                   KONRAD AT HOME
    #######################################################################################################################################################
    # need to do this last, because it temporariy stores all the previously-created units
    [event]
        name=prestart
        priority=-50
        [store_unit]
            {FILTER( id=Konrad )}
            kill,variable=yes,stored_s01_konrad
        [/store_unit]
        [store_unit]
            {FILTER( {NOT id=Konrad} )}
            kill,variable=yes,stored_s01_units
        [/store_unit]
        
        #############################
        # SET UP NEW MAP
        #############################
        [replace_map]
            map_file=01a_Home.map
            expand,shrink=yes,yes
        [/replace_map]
        [zoom]
            factor,relative=0.8,no
        [/zoom]
        {PLACE_IMAGE items/gohere.png            17 11}
        {PLACE_IMAGE items/gohere.png            18 10}
        {PLACE_IMAGE items/bed.png               13  5}
        {PLACE_IMAGE items/flower-blue.png       12  4}
        {PLACE_IMAGE items/flower-orange.png     13  4}
        {PLACE_IMAGE "items/flower-red.png~FL()" 14  5}
        {PLACE_IMAGE items/flower3.png           15 11}
        {PLACE_IMAGE items/boxes.png             10  6}
        {PLACE_IMAGE items/desk.png              11  6}
        {PLACE_IMAGE items/chair.png             12  6}
        {PLACE_IMAGE items/konrad-weapons.png    12  7}
        {PLACE_HALO  items/counter.png           18  6}
        {PLACE_HALO  items/bookshelves.png       15  7}
        {GENERIC_UNIT 4 Quintain 9 11} {FACING ne}
        {GENERIC_UNIT 4 Quintain 9 12} {FACING ne}
        [zoom]
            factor,relative=1,no
        [/zoom]
        [place_shroud]
            side=1 # fill entire map with shroud
        [/place_shroud]
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        {SCROLL_TO 13 1}
        
        # this gold pickup serves as a lure, to make players trigger the bookshelf event
        # (and the bookshelf event teaches the player that there are more events in the house)
        {GOLD_PICKUP 17 6 items/gold-coins-small.png 10 "10 gold" _"A little gold for use in magical experiments. I’m sure it won’t be missed."}
        [modify_side]
            side,income=1,-2
        [/modify_side]
    [/event]
    
    #############################
    # EMULATE BIGMAP
    #############################
    [event]
        name=start
        [disallow_end_turn]
        [/disallow_end_turn]
    [/event]
    [event]
        name=moveto,unit placed,attack end
        first_time_only=no
        {FILTER id=Konrad}
        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
        [heal_unit]
            {FILTER id=Konrad}
            moves=full
        [/heal_unit]
        {FULL_HEAL type=Quintain} # not Konrad, since he can take 1 damage from his splinter
    [/event]
    [event]
        name=enter hex,unit placed
        first_time_only=no
        {FILTER id=Konrad}
        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
        [remove_shroud]
            {FILTER_SIDE side=1}
            x,y,radius=$unit.x,$unit.y,7
        [/remove_shroud]
    [/event]
    
    #############################
    # KONRAD WAKES UP
    #############################
    [event]
        name=start
        {DELAY 1500}
        [message]
            speaker=narrator
            #po: this is Delfador trying to wake up a sleeping Kornad, as heard from Konrad's perspective
            message=_"<span size='xx-small'>Konrad!</span>"
        [/message]
        [message]
            speaker=narrator
            #po: this is Delfador trying to wake up a sleeping Kornad, as heard from Konrad's perspective
            message=_"<span size='small'>Konrad, wake up!</span>"
        [/message]
        {DELAY 1000}
        {SCREEN_FADER 0,0,0 255 0} # fade out now and back in later, so that shroud removal looks gradual
        [unit]
            {SINGLEUNITWML_KONRAD}
            side,x,y,facing=1,13,5,ne
            type=Sleeping_Fighter
        [/unit]
        {SWITCH_KONRAD_PORTRAIT young ""}
        {MODIFY_UNIT id=Konrad ellipse none}
        {SCREEN_FADER 0,0,0 000 500}
        [message]
            speaker=Konrad
            #po: the "dream" Konrad refers to is the intro storytext. This is a justification for the artwork not perfectly matching the characters' appearances
            message=_"*yawn*, what a vivid dream. Asheviere and Eldred, Delfador and Garard, just like in the histories..." # Of course, Delfador would have been much younger back then..."
        [/message]
        {DELAY 500}
        [message]
            # if we're assuming the player is coming from TDG/AA/L, they don't yet know that Delfador is old (though the intro images are a pretty good clue)
            speaker,caption,image=narrator,_"Delfador",portraits/delfador-elvish-unknown.png 
            message=_"Wake up, wake up, wake up! Curse you Konrad, get up and get out here! We’re under attack!"
        [/message]
        {DELAY 250}
        [unit]
            {SINGLEUNITWML_KONRAD}
            side,x,y,facing=1,13,5,sw
            type=Unarmed_Fighter
            overwrite=yes
        [/unit]
        {SWITCH_KONRAD_PORTRAIT young ""}
        {DELAY 250}
        [message]
            speaker=Konrad
            #po: Konrad has heard Delfador calling him but is not concerned. Delfador tries to surprise Konrad with training. In reality, there's a real battle being fought
            message=_"I’m up, I’m up. What’s training today, Delfador? Orcs in the walls? Magi under my bedsheets?"
        [/message]
        [message]
            speaker,caption,image=narrator,_"Delfador",portraits/delfador-elvish-unknown.png
            message=_"No, you daft child, nothing like that! Grab your sword and come outside!"
        [/message]
        
        #############################
        # KONRAD GRABS HIS SWORD
        #############################
        {DELAY 500}
        {MOVE_UNIT id=Konrad 12 7}
        {FIRE_EVENT_UNIT enter_hex id=Konrad}
        {MODIFY_UNIT id=Konrad facing se}
        {DELAY 500}
        {REMOVE_IMAGE 12 7}
        [unstore_unit]
            x,y,variable=12,7,stored_s01_konrad
        [/unstore_unit]
        {CLEAR_VARIABLE stored_s01_konrad}
        {SWITCH_KONRAD_PORTRAIT young ""}
        {GIVE_OBJECT_TO id=Konrad (
            id=konrad_emulate_bigmap
            {EFFECT movement set=50}
            {EFFECT movement_costs (replace=yes
                [movement_costs]
                    flat,sand,frozen,village,castle=1,1,1,1,1
                    deep_water,shallow_water,reef,swamp_water=
                    forest,hills,mountains,fungus,unwalkable=
                [/movement_costs] )}
            {EFFECT vision set=0}
        )}
        {MODIFY_UNIT id=Konrad moves 50}
        [message]
            speaker=Konrad
            #po: the intent of this is to show that 1) Konrad trains regularly with Delfador and 2) Konrad is living with and on friendly terms with elves, particulary Ethiliel
            message=_"<span size='small'>Well, I’d better do as he says. Last time I missed battle training, Ethiliel made me spend all week transcribing her poetry. *shudder*</span>"
        [/message]
        [objectives]
            [objective]
                description= _ "Explore your home"
                condition=win
            [/objective]
            [objective]
                description= _ "Meet Delfador"
                condition=win
            [/objective]
        [/objectives]
        
        #############################
        # FLOWER EVENT
        #############################
#         [event]
#             name=enter hex
#             {FILTER x,y=15,11}
#             {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
#             [message]
#                 speaker=Konrad
#                 #po: Konrad has just sniffed a flower
#                 message=_"*sniff* Delicate and sweet. Delfador and Kaylan know much about warfare and politics, but Ethiliel is the one who understands beauty."
#             [/message]
#             [cancel_action]
#             [/cancel_action]
#         [/event]
        
        #############################
        # BED EVENT
        #############################
        [event]
            name=enter hex
            {FILTER x,y=13,5}
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            [message]
                speaker=Konrad
                #po: the player has moved Konrad to his bed
                message=_"No time to rest! Got to train hard if I ever want to be a good king."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]
        
        #############################
        # DESK EVENT
        #############################
        [event]
            name=enter hex
            {FILTER( {FILTER_LOCATION x,y,radius=11,6,1} )}
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            [message]
                speaker=Konrad
                #po: the player has moved Konrad near a writing desk. This foreshadows Asheveire's large-scale invasion
                message=_"Looks like Delfador’s written part of a letter. “<i>Sir Kaylan, I hope this missive finds you well. Lord Maddock’s latest report is worrying: the recent mobilization suggests...</i>”"
            [/message]
            [message]
                speaker=Konrad
                message=_"The letter trails off there."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]
        
        #############################
        # BOOKSHELF EVENT
        #############################
        [event]
            name=enter hex
            {FILTER x,y=16-17,7}
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            {MODIFY_UNIT id=Konrad facing nw}
            [message]
                speaker=Konrad
                #po: Konrad has moved near a bookshelf
                message=_"“<i>Ambassador Deoran’s Political Primer</i>”
“<i>Basics of Swordsmanship, feat. Sergeant Mari</i>”
“<i>An Abridged History of Wesnoth, by Delfador the Great</i>”"
            [/message]
            [message]
                speaker=Konrad
                message=_"My textbooks, courtesy of the Aethenwood. The shelves get fuller every day."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]
        
        #############################
        # RIVER EVENT
        #############################
        [event]
            name=enter hex
            {FILTER( {FILTER_LOCATION terrain=W*^*} )}
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            {SOUND water.wav}
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                #po: Konrad is drinking or bathing in a stream
                message=_"Ahhh, cool and refreshing. Delfador would probably worry it’s been poisoned."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]
        
        #############################
        # QUINTAIN EVENT
        #############################
        [event]
            name=attack end
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                #po: Konrad is attacking a quintain
                message=_"Hi-ya! Take that Eldred! Take that Asheviere!"
            [/message]
            [event]
                name=attack end
                {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                [event]
                    name=attack end
                    {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                    [event]
                        name=attack end
                        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                        [harm_unit]
                            {FILTER id=Konrad}
                            amount,animate=1,yes
                        [/harm_unit]
                        {MODIFY_UNIT id=Konrad experience 1}
                        [floating_text]
                            x,y=$unit.x,$unit.y
                            text=_"<span size='x-small'>+1 experience</span>"
                        [/floating_text]
                        [message]
                            speaker=Konrad
                            message=_"Ouch! A splinter!"
                        [/message]
#                         {MODIFY_UNIT id=Konrad attacks_left 0}
                    [/event]
                [/event]
            [/event]
        [/event]
        [event]
            name,first_time_only=attack end,no
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            {MODIFY_UNIT id=Konrad attacks_left 1}
        [/event]
    [/event]
    #######################################################################################################################################################
    #                                                                 KONRAD LEAVES HOME
    #######################################################################################################################################################
    [event]
        name=enter hex
        {FILTER( x,y=17,11 {OR x,y=18,10} )}
        [cancel_action]
        [/cancel_action]
        [message]
            speaker=Konrad
            #po: Konrad is leaving home, kicking off the main scenario
            message=_"Well, time to see what Delfador’s so excited about."
        [/message]
        {MOVE_UNIT id=Konrad 28 17}
        
        #############################
        # CLEAN UP
        #############################
        {SCREEN_FADER 0,0,0 255 500}
        {REMOVE_IMAGE 0-99 0-99}
        {REMOVE_LABEL 0-99 0-99}
        {KILL type=Quintain}
        
        #############################
        # RESTORE BATTLE MAP
        #############################
        [replace_map]
            map_file=01_The_Elves_Besieged.map
            expand,shrink=yes,yes
        [/replace_map]
        [foreach]
            array=stored_s01_units
            [do][unstore_unit]
                variable=this_item
            [/unstore_unit][/do]
        [/foreach]
        {CLEAR_VARIABLE stored_s01_units}
        [remove_object]
            object_id=konrad_emulate_bigmap
        [/remove_object]
        [allow_end_turn]
        [/allow_end_turn]
        
        #############################
        # INITIALIZE GAME STATE
        #############################
        [modify_side]
            side,shroud,income=1,no,0
        [/modify_side]
        
        {FIRE_EVENT play_battle}
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE 140 SHROUD=yes}
        # +10 gold on all difficulties from a pickup in Konrad's house
        # shroud only used for Konrad's house
    
    #############################
    # ELVES
    #############################
    [event] name=prestart {UNSTORE_NPC Ethiliel x,y=13,13 side,facing=2,nw} [/event]
    [side]
        side,controller,color=2,ai,brightgreen
        hidden=yes
        recruit=Elvish Ranger
        gold={ON_DIFFICULTY4 50 75 100 100}
        income={ON_DIFFICULTY4 4 8 12 12} # plus 2-4 villages, and >>4 upkeep. Don't let them die too easily, or Flight doesn't make sense
        team_name,user_team_name=konrad,_"Aethenwood Elves"
        {FLAG_VARIANT wood-elvish}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 0}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Marksman" {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Archer"   {ON_DIFFICULTY4 1 1 2 2}}
    
    [event] name=prestart {UNSTORE_NPC Galdrad x,y=35,16 side,facing=3,se} [/event]
    [side]
        side,controller,color=3,ai,brightgreen
        hidden=yes
        gold={ON_DIFFICULTY4 100 125 150 150}
        income={ON_DIFFICULTY4 8 16 24 24} # plus 2 villages, and >>2 upkeep. Don't let them die too easily, or Flight doesn't make sense
        recruit=Elvish Hero
        team_name,user_team_name=konrad,_"Aethenwood Elves"
        {FLAG_VARIANT wood-elvish}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 0}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Captain" {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Elvish Fighter" {ON_DIFFICULTY4 1 1 2 2}}
    
    [event] 
        name=play_battle
        [modify_side]{BR} side,hidden=2,no {BR}[/modify_side] 
        [modify_side]{BR} side,hidden=3,no {BR}[/modify_side] 
        [capture_village]{BR} side,x,y,radius=2,10,18,9 {BR}[/capture_village]
        [capture_village]{BR} side,x,y,radius=3,34,13,5 {BR}[/capture_village]
    [/event]
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3 no 0.1 0.9}
        
        # Ethiliel's AI. Stay near leader, stay on forest, and avoid fires
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=10,13})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=14,16})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=12,15})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=14,13})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=13,12})}
        {MODIFY_SIDE_AI 2 ([avoid]
            {NOT( x,y,radius=12,14,4 )}
            {OR( find_in=fires )}
        [/avoid])}
        
        # Galdrad's AI. Stay near leader, stay on forest, and avoid fires
        {MODIFY_SIDE_AI 3 ({GOAL_LOCATION 3 x,y=35,12})}
        {MODIFY_SIDE_AI 3 ({GOAL_LOCATION 3 x,y=38,15})}
        {MODIFY_SIDE_AI 3 ({GOAL_LOCATION 2 x,y=36,14})}
        {MODIFY_SIDE_AI 3 ({GOAL_LOCATION 2 x,y=38,17})}
        {MODIFY_SIDE_AI 3 ({GOAL_LOCATION 1 x,y=33,14})}
        {MODIFY_SIDE_AI 3 ({GOAL_LOCATION 1 x,y=34,17})}
        {MODIFY_SIDE_AI 3 ([avoid]
            {NOT( x,y,radius=34,16,4 )}
            {OR( find_in=fires )}
        [/avoid])}
    [/event]
    
    
    #############################
    # MEN
    #############################
    [side]
        side,controller,color=4,ai,wesred
        type,id,facing,gender=Red Mage,wesredmage,sw,female
        {MODIFICATIONS( {TRAIT_INTELLIGENT} {TRAIT_QUICK} )}
        gold,income={ON_DIFFICULTY4 30 60 120 120},{ON_DIFFICULTY4 -2 0 4 4} # plus 4 villages
        hidden,recruit=yes,Mage
        team_name,user_team_name=wesnoth,_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    
    [event] name=prestart {UNSTORE_NPC Isolde x,y=48,9 side,facing=5,sw} [/event]
    [side]
        side,controller,color=5,ai,wesred
        gold,income={ON_DIFFICULTY4 30 60 120 120},{ON_DIFFICULTY4  0 3 8 8} # plus 5 villages
        hidden,recruit=yes,Spearman
        team_name,user_team_name=wesnoth,_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    {SILENTLY_LIMIT_LEADER_MOVES 5 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Spearman"  {ON_DIFFICULTY4 0 1 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Bowman"    {ON_DIFFICULTY4 0 1 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Swordsman" {ON_DIFFICULTY4 0 1 2 3}}
    [event]
        name=play_battle
        [modify_side]{BR} side,hidden=4,no {BR}[/modify_side] 
        [modify_side]{BR} side,hidden=5,no {BR}[/modify_side] 
        [capture_village]{BR} side,x,y,radius=4,43,3,2  {BR}[/capture_village]
        [capture_village]{BR} side,x,y,radius=4,40,1,0  {BR}[/capture_village]
        [capture_village]{BR} side,x,y,radius=5,48,10,3 {BR}[/capture_village]
    [/event]
    
    [side]
        side,controller,color=6,ai,wesred
        type,id,facing=Swordsman,swordsman,nw
        {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_QUICK} )}
        gold,income={ON_DIFFICULTY4 30 60 120 120},{ON_DIFFICULTY4 -2 0 4 4}
        hidden,recruit=yes,Spearman
        team_name,user_team_name=wesnoth,_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    [side]
        side,controller,color=7,ai,wesred
        type,id,facing=Longbowman,longbowman,nw
        {MODIFICATIONS( {TRAIT_INTELLIGENT} {TRAIT_RESILIENT} )}
        gold,income={ON_DIFFICULTY4 30 60 120 120},{ON_DIFFICULTY4 -2 0 4 4}
        hidden,recruit=yes,Bowman
        team_name,user_team_name=wesnoth,_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    [side]
        side,controller,color=8,ai,wesred
        type,id,facing=Javelineer,javelineer,se
        {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_RESILIENT} )}
        gold,income={ON_DIFFICULTY4 30 60 120 120},{ON_DIFFICULTY4 -2 0 4 4}
        hidden,recruit=yes,Spearman
        team_name,user_team_name=wesnoth,_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 6 1}
    {SILENTLY_LIMIT_LEADER_MOVES 7 1}
    {SILENTLY_LIMIT_LEADER_MOVES 8 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Bowman"   {ON_DIFFICULTY4 0 1 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Spearman" {ON_DIFFICULTY4 0 1 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Bowman"   {ON_DIFFICULTY4 0 1 1 2}}
    [event]
        name=play_battle
        [modify_side]{BR} side,hidden=6,no {BR}[/modify_side] # plus 4-6 villages
        [modify_side]{BR} side,hidden=7,no {BR}[/modify_side] # plus 4-6 villages
        [modify_side]{BR} side,hidden=8,no {BR}[/modify_side] # plus 4-6 villages
        [capture_village]{BR} side,x,y,radius=6,41,24,4 {BR}[/capture_village]
        [capture_village]{BR} side,x,y,radius=7,24,21,6 {BR}[/capture_village]
        [capture_village]{BR} side,x,y,radius=8,12,3,5  {BR}[/capture_village]
    [/event]
    [event]
        name=side 4 turn
        first_time_only=no
        {RESET_SIDE_AI 4,5   offensive 0.4 0.25}
        {RESET_SIDE_AI 6,7,8 offensive 0.4 0.25}
        
        {MODIFY_SIDE_AI 4   ({GOAL_SEEK_SIDE 99 1 0})}
        {MODIFY_SIDE_AI 5,6 ({GOAL_SEEK_SIDE 99 3 0})}
         
        [if] {LUA(<<return wesnoth.current.turn<=2>>)}
            {THEN( {MODIFY_SIDE_AI 7 ({GOAL_SEEK_SIDE 99 2 0})} )}
            {ELSE( {MODIFY_SIDE_AI 7 ({GOAL_SEEK_SIDE 99 1 0})} )}
        [/if]
        [if] {LUA(<<return wesnoth.current.turn<=3>>)}
            {THEN( {MODIFY_SIDE_AI 8 ({GOAL_SEEK_SIDE 99 2 0})} )}
            {ELSE( {MODIFY_SIDE_AI 8 ({GOAL_SEEK_SIDE 99 1 0})} )}
        [/if]
        
        # avoid fires
        [store_items]
            item_name=fire
            variable=fires
        [/store_items]
        {MODIFY_SIDE_AI 4,5,6,7,8 ([avoid]
            find_in=fires # this doesn't affect their zone_guardians
        [/avoid])}
    [/event]
    
    [side] # Delfador dummy side
        side,controller,color=9,null,blue
        hidden,no_leader,team_name=yes,yes,konrad
    [/side]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                  PLAY MAIN SCENARIO
    #######################################################################################################################################################
    [event]
        name=play_battle
        
        #############################
        # NORTHERN FIRES
        #############################
        {PLACE_FIRE  3  9}
        {PLACE_FIRE  3 12}
        {PLACE_FIRE  6 12}
        {PLACE_FIRE  8 12}
        {PLACE_FIRE  7 13}
        {PLACE_FIRE  7 10}
        {PLACE_FIRE 11 11}
        {PLACE_FIRE 13  9}
        {PLACE_FIRE 14  8}
        {PLACE_FIRE 15  8}
        {PLACE_FIRE 15  6}
        
        {PLACE_FIRE 19  4}
        {PLACE_FIRE 20  2}
        {PLACE_FIRE 21  2}
        {PLACE_FIRE 27  2}
        {PLACE_FIRE 26  2}
        {PLACE_FIRE 28  2}
        {PLACE_FIRE 29  2}
        
        {PLACE_FIRE 35  7}
        {PLACE_FIRE 36  6}
        {PLACE_FIRE 37  4}
        
        #############################
        # EASTERN FIRES
        #############################
        {PLACE_FIRE 37 10}
        {PLACE_FIRE 39 10}
        {PLACE_FIRE 40 10}
        {PLACE_FIRE 39 11}
        {PLACE_FIRE 40 11}
        {PLACE_FIRE 42 13}
        {PLACE_FIRE 41 13}
        {PLACE_FIRE 43 14}
        {PLACE_FIRE 43 15}
        {PLACE_FIRE 43 16}
        {PLACE_FIRE 42 15}
        {PLACE_FIRE 45 13}
        
        #############################
        # SOUTHERN FIRES
        #############################
        {PLACE_FIRE 39 18}
        {PLACE_FIRE 36 20}
        {PLACE_FIRE 41 21}
        {PLACE_FIRE 30 19}
        {PLACE_FIRE 22 23}
        {PLACE_FIRE 26 18}
        {PLACE_FIRE 24 19}
        {PLACE_FIRE 18 26}
        {PLACE_FIRE 18 25}
        
        # fires start out having already burned a little
        {IMPLEMENT_FIRES 0}
        {REPEAT 3 ({FIRE_EVENT tick_fires})}
        
        
        #############################
        # ELVISH GUARDS
        #############################
        {GENERIC_UNIT 2 (Elvish Ranger)  14 16} {FACING nw} {GENDER female} {ZONE_GUARDIAN 14 16 x,y,radius=11,14,2}
        {GENERIC_UNIT 2 (Elvish Archer)  10 13} {FACING ne} {GENDER male  } {ZONE_GUARDIAN 10 13 x,y,radius=13,16,2}
        {GENERIC_UNIT 2 (Elvish Archer)  18 13} {FACING nw} {GENDER female} {ZONE_GUARDIAN 18 13 x,y,radius=17,13,2}
        {GENERIC_UNIT 3 (Elvish Fighter) 35 13} {FACING ne} {ZONE_GUARDIAN 35 13 x,y,radius=33,13,1}
        {GENERIC_UNIT 3 (Elvish Hero)    38 15} {FACING nw} {ZONE_GUARDIAN 38 15 x,y,radius=38,15,1}
        {GENERIC_UNIT 3 (Elvish Archer)  34 15} {FACING ne} {GENDER female}
        
        #############################
        # HUMAN GUARDS
        #############################
        {GENERIC_UNIT 4 (Bowman)    42  7} {FACING sw} {ZONE_GUARDIAN 42  7 ( x,y,radius=44,7,3 {OR x,y,radius=49,10,4} )}
        {GENERIC_UNIT 4 (Swordsman) 46  8} {FACING sw} {ZONE_GUARDIAN 46  8 ( x,y,radius=44,7,3 {OR x,y,radius=49,10,4} )}
        {GENERIC_UNIT 5 (Spearman)  46 10} {FACING sw} {ZONE_GUARDIAN 46 11 ( x,y,radius=44,7,3 {OR x,y,radius=49,10,4} )}
        {GENERIC_UNIT 5 (Spearman)  49 13} {FACING sw} {ZONE_GUARDIAN 49 13 ( x,y,radius=44,7,3 {OR x,y,radius=49,10,4} )}
        {GENERIC_UNIT 6 (Spearman)   7  5} {FACING se} {ZONE_GUARDIAN  7  5 ( x,y,radius=6,3,3 )}
        {GENERIC_UNIT 6 (Bowman)     3  4} {FACING se} {ZONE_GUARDIAN  3  4 ( x,y,radius=6,3,3 )}
        {GENERIC_UNIT 6 (Spearman)  41 20} {FACING se} {ZONE_GUARDIAN 41 20 ( x,y,radius=41,22,3 )}
        {GENERIC_UNIT 7 (Spearman)  30 24} {FACING nw} {ZONE_GUARDIAN 30 24 ( x,y,radius=28,26,4 )}
        
        #############################
        # HUMAN ATTACKERS
        #############################
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "none"     "none"     "Mage"     "Mage"     } 43  6 ()}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "none"     "Mage"     "Mage"     "Mage"     } 44  7 ()}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "none"     "none"     "Mage"     "Mage"     } 45  7 ()}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Swordsman"} 47 10 ()}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman" } 48 10 ()}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "none"     "Spearman" "Spearman" } 49 10 ()}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 48  8 ()}
        
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "none"     "Spearman" "Spearman" } 41 24 ()}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 41 25 ()}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 43 24 ()}
        
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "Bowman"   "Bowman"   "Bowman"   "Bowman"   } 27 25 ({ROLE quick}{ZONE_GUARDIAN 11 21 ( {FILTER side=1} {AND x,y,radius=4,26,14} )})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"     "none"     "Fencer"   "Fencer"   } 24 26 ({ROLE quick}{ZONE_GUARDIAN 15 23 ( {FILTER side=1} {AND x,y,radius=4,26,14} )})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 31 25 ({ROLE quick}{ZONE_GUARDIAN  8 24 ( {FILTER side=1} {AND x,y,radius=4,26,14} )})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"     "Fencer"   "Fencer"   "Fencer"   } 27 26 ({ROLE quick}{ZONE_GUARDIAN  2 19 ( {FILTER side=1} {AND x,y,radius=1,23,10} )})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 28 24 ({ROLE quick}{ZONE_GUARDIAN 18 19 ( {FILTER side=1} {AND x,y,radius=1,23,10} )})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"   } 22 26 ({ROLE quick}{ZONE_GUARDIAN  4 20 ( {FILTER side=1} {AND x,y,radius=1,23,10} )})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 25 22 ()}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 27 23 ()}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"     "none"     "Spearman" "Spearman" } 31 22 ()}
        
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" }  6  3 ({ROLE quick}{ZONE_GUARDIAN  2 15 ( {FILTER side=1} {AND x,y,radius=1,15-22,8 } )})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"   }  8  3 ({ROLE quick}{ZONE_GUARDIAN  1 14 ( {FILTER side=1} {AND x,y,radius=1,15-22,8 } )})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Fencer"   "Fencer"   }  9  3 ({ROLE quick}{ZONE_GUARDIAN  5 16 ( {FILTER side=1} {AND x,y,radius=1,15-22,8 } )})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman" } 11  4 ()}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 12  3 ()}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 17  3 ()}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Spearman" "Spearman" } 16  3 ()}
        
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 40  1 ({FACING sw})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"   } 38  1 ({FACING sw}{GUARDIAN})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Fencer"   "Fencer"   } 37  1 ({FACING sw})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman" } 35  1 ({FACING se})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 38  2 ({FACING sw})}
        
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 34  4 ({ROLE quick}{FACING sw})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 34  3 ({ROLE quick}{FACING sw})}
        
#define SET_TRAITS TRAITS
        [remove_trait]
            id=$unit.id
        [/remove_trait]
        [modify_unit]
            {FILTER id=$unit.id}
            {TRAITS}
        [/modify_unit]
#enddef
        [store_unit]
            {FILTER role=quick}
            variable=stored_quick_units
        [/store_unit]
        [foreach]
            array=stored_quick_units
            variable=unit
            [do]
                {VARIABLE_OP rand rand (1,2,3,4)}
                [if] {VARIABLE_CONDITIONAL rand equals 1} {THEN(  {SET_TRAITS ({TRAIT_QUICK    }{TRAIT_STRONG   })}  )} [/if]
                [if] {VARIABLE_CONDITIONAL rand equals 2} {THEN(  {SET_TRAITS ({TRAIT_QUICK    }{TRAIT_RESILIENT})}  )} [/if]
                [if] {VARIABLE_CONDITIONAL rand equals 3} {THEN(  {SET_TRAITS ({TRAIT_STRONG   }{TRAIT_QUICK    })}  )} [/if]
                [if] {VARIABLE_CONDITIONAL rand equals 4} {THEN(  {SET_TRAITS ({TRAIT_RESILIENT}{TRAIT_QUICK    })}  )} [/if]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_quick_units}
        
        #############################
        # KONRAD
        #############################
        {MODIFY_UNIT id=Konrad attacks_left 1}
        {PUT_TO_RECALL_LIST id=Konrad}
        {GIVE_OBJECT_TO id=Konrad (
            id=konrad_silver_crown_object
            {EFFECT overlay remove=misc/leader-crown.png}
            {EFFECT overlay add=misc/leader-expendable.png}
        )}
        
        #############################
        # DELFADOR
        #############################
        {UNSTORE_NPC Delfador x,y=25,9 (
            side,facing=9,sw
            hitpoints,experience=27,5 )}
        [set_extra_recruit]
            id=Delfador
            extra_recruit=Mudcrawler,Giant Mudcrawler,Fire Guardian,Fire Wraith
        [/set_extra_recruit]
        {GENERIC_UNIT 9 "Fire Wraith"   22  8} {ROLE wraith} {FACING sw} {HITPOINTS 36}
        {GENERIC_UNIT 9 "Fire Guardian" 23 11} {ROLE fguard} {FACING ne} {HITPOINTS  8}
        {GENERIC_UNIT 6 "Silver Mage"   22  9} {ROLE smage1} {FACING sw} {HITPOINTS 22} {GENDER female}
        {GENERIC_UNIT 6 "Silver Mage"   23 10} {ROLE smage2} {FACING ne} {HITPOINTS 15} {GENDER male  }
        {GENERIC_UNIT 6 "Assassin"      25  8} {ROLE assass} {FACING se} {HITPOINTS 14} {GENDER female}
        [capture_village]{BR} side,x,y,radius=1,25,10,5 {BR}[/capture_village]
        {SCROLL_TO 25 9}
        
        
        
        #############################
        # PLAY CUTSCENE
        #############################
        # cutscene establishes that 1) Delfador is old now, and 2) Delfador is still plenty powerful
        {FADE_MUSIC_OUT 500}
        {REPLACE_SCENARIO_MUSIC siege_of_laurelmor.ogg}
        {APPEND_MUSIC juggernaut.ogg}
        {FADE_MUSIC_IN 0}
        {SCREEN_FADER 0,0,0 000 500}
        {DELAY 750}
        [message]
            speaker=Delfador {DELFADOR_VARIATION mad}
            #po: Delfador is fighting multiple high-level enemies
            message=_"Servants of Asheviere, tremble before my wrath!"
        [/message]
        {MOVE_UNIT    role=wraith 23 9}
        {ANIMATE_HARM role=wraith  8 range=ranged role=smage1}
        {ANIMATE_HARM role=smage1  5 range=ranged role=wraith}
        {ANIMATE_HARM role=wraith  8 range=ranged role=smage1}
        {ANIMATE_HARM role=smage1  5 range=ranged role=wraith}
        {ANIMATE_HARM role=smage1  5 range=ranged role=wraith}
        {ANIMATE_HARM role=smage1  5 range=ranged role=wraith}
        {DELAY 250}
        {ANIMATE_HARM role=smage2 5 range=ranged role=fguard}
        {ANIMATE_HARM role=fguard 8 range=ranged role=smage2}
        {ANIMATE_HARM role=smage2 5 range=ranged role=fguard}
        {DELAY 250}
        {MOVE_UNIT    role=assass 23 8} {DELAY 250}
        {ANIMATE_HARM role=assass 16 range=melee  role=wraith}
        {DELAY 250}
        {MOVE_UNIT    id=Delfador 23 9} {DELAY 250}
        {ANIMATE_HARM id=Delfador 14 range=ranged role=assass}
        {ANIMATE_HARM id=Delfador  7 range=ranged role=smage1}
        {ANIMATE_HARM id=Delfador  7 range=ranged role=smage2}
        {DELAY 500}
        {MOVE_UNIT id=Delfador 24 9}
        {MODIFY_UNIT id=Delfador facing sw}
        {DELAY 500}
        [message]
            speaker=Delfador
            #po: Delfador has vanquished his attackers
            message=_"Serves you right, sneaking up on an old man like that! Hmph. Nearly gave me a heart attack."
        [/message]
        
        #############################
        # EXPLAIN SCENARIO
        #############################
        {RECALL_XY Konrad 29 7}
        {MODIFY_UNIT id=Konrad facing sw}
        {MODIFY_UNIT id=Delfador facing ne}
        {DELAY 500}
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"I’m here, Delfador! Sorry it took so long! I thought you were calling me for more training, but that was a real battle, wasn’t it? And I see smoke rising from the forest! What’s going on?"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            #po: human armies have surrounded the Aethenwood and are burning it
            message=_"Trouble from your “Queen Asheviere”, human! She must know we sheltered you throughout your childhood. Now she comes bearing firey retribution, and the dawn of a dark age for the Aethenwood."
        [/message]
        {SCROLL_TO 1   1} {DELAY 750}
        {SCROLL_TO 50  1} {DELAY 750}
        {SCROLL_TO 50 26} {DELAY 750}
        [message]
            speaker=Delfador
            message=_"And those assassins I just defeated were after you personally, master Konrad! We need to get you out of here!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            #po: it's a little odd for Konrad (a human) to refer to them as "the humans", but keep in mind he was raised among elves
            message=_"But Delfador, the humans are burning our home! They’re trying to kill our friends! We have to help fight."
        [/message]
        [message]
            speaker=Delfador
            #po: this is the first time we see the contrasts between Konrad and Delfador. Konrad wants to help the people in front of him. Delfador prefers to sacrifice for the greater picture.
            message=_"Do not throw your life away so easily, your highness. The true heir is a symbol of hope to everyone oppressed by Asheviere’s tyrrany, both men and elves alike! If you do not escape this battle, all chance of rebellion will be lost."
        [/message]
        [message]
            speaker=Galdrad
            message=_"Asheviere is all of ours’ enemy. We will fight the invaders, but you must escape, Konrad. Lord Kalenz has commanded your safety. It is imperative that you escape!"
        [/message]
        [message]
            speaker=Delfador
            message=_"There can be no looking back. We must go quickly!"
        [/message]
        
        [change_theme]
        [/change_theme]
        {MODIFY_UNIT side=9 side 1}
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Move Konrad and Delfador to the west edge of the map"
                condition=win
            [/objective]
#             [objective]
#                 {BONUS_OBJECTIVE_CAPTION}
#                 description= _ "Protect Galdrad (+10 gold carryover)"
#                 [show_if] {HAVE_UNIT id=Galdrad} [/show_if]
#                 condition=win
#             [/objective]
#             [objective]
#                 description= _ "Protect Ethiliel (+10 gold carryover)"
#                 [show_if] {HAVE_UNIT id=Ethiliel} [/show_if]
#                 condition=win
#             [/objective]
            [objective]
                description= _ "Death of Konrad or Delfador"
                condition=lose
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=40,no
            [/gold_carryover]
            # this is a meaningful but not crucial mechanic, and I think it's more fun for the player to discover this on their own
#             [note]
#                 description= _ "Units take 1 fire damage whenever they enter flaming terrain, and 10 fire damage if they end their turn in it. Fire elementals are immune."
#             [/note]
        [/objectives]
    [/event]
    
    
    #######################################################################################################################################################
    #                                                                     GOLD BOOSTS
    #######################################################################################################################################################
# give gold per leader. Easier way to implement this than changing each side's income individually and per-difficulty
#define BONUS_INCOME_PER_LEADER INCOME
    # newline for inline usage
    [event]
        name,first_time_only=new turn,no
        [store_unit]
            {FILTER( canrecruit=yes {NOT side=1} )}
            variable=stored_enemy_leaders
        [/store_unit]
        [foreach]
            array=stored_enemy_leaders
            [do]
                [gold]
                    side=$this_item.side
                    amount={INCOME}
                [/gold]
            [/do]
        [/foreach]
    [/event]
#enddef
    [event]
        name=turn 5
        {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 2 3 5 5}}
    [/event]
    [event]
        name=turn 10
        {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 4 6 10 10}}
    [/event]
    [event]
        name=turn 15
        {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 8 12 20 20}}
        [modify_unit]
            {FILTER side=4}
            extra_recruit=Red Mage,White Mage
        [/modify_unit]
        [modify_unit]
            {FILTER side=5,6,7,8}
            extra_recruit=Swordsman,Javelineer
        [/modify_unit]
    [/event]

    
    #######################################################################################################################################################
    #                                                                       FLAVOR
    #######################################################################################################################################################
    #############################
    # KONRAD’S NEVER SEEN THIS MANY HUMANS
    #############################
    [event]
        name=turn 3
        [message]
            speaker=Delfador
            message=_"Konrad, it took you some time to rise this morning. I’m not angry, but I am worried. Those assassins were after you, not me! What would have happened if I hadn’t been there to keep you safe?"
        [/message]
        [message]
            speaker=Konrad
            #po: Asheviere and her army are burning the Aethenwood and killing Konrad's elven friends.
            message=_"I know, Delfador, and I’m sorry. This is horrible! How did the fires get so close without me noticing!?"
        [/message]
        [message]
            speaker=Konrad
            #po: Asheviere and her army are burning the Aethenwood and killing Konrad's elven friends.
            message=_"I’ve never seen so many humans all in one place before. I can’t believe you and I are really the same as them..."
        [/message]
        [message]
            speaker=Delfador
            message=_"<i><b>I’m</b></i> sorry you couldn’t have grown up among your own people. Our kind can be a little crude, but we aren’t usually so bad — it’s Asheviere who’s stirred up all this mischief."
        [/message]
        [message]
            speaker=Delfador
            message=_"And if my suspicions are true, this is merely a small part of the greater whole of her armies! We must get out of this forest so we can see what else is going on."
        [/message]
    [/event]
    #############################
    # SURROUND THE ELVES - NO ESCAPE
    #############################
    [event]
        name=turn 3 end
        [message]
            role,x=quick,0-15
            message=_"Surround the enclaves! Don’t let anyone escape!"
        [/message]
    [/event]
    
    #############################
    # "I AM GALDRAD"
    #############################
    [event]
        name=attack {FILTER        id=Galdrad}
        {FIRE_EVENT galdrad_speaks}
    [/event]
    [event]
        name=attack {FILTER_SECOND id=Galdrad}
        {FIRE_EVENT galdrad_speaks}
    [/event]
    [event]
        name=galdrad_speaks
        [message]
            speaker=Galdrad
            message=_"I am Galdrad. You will have to fight me to get any further!"
        [/message]
    [/event]
    #############################
    # KONRAD ATTACKS
    #############################
    [event]
        name=attack {FILTER        id=Konrad}
        {FILTER_CONDITION( {NOT({HAVE_UNIT type=Quintain})} )}
        {FIRE_EVENT konrad_speaks}
    [/event]
    [event]
        name=attack {FILTER_SECOND id=Konrad}
        {FILTER_CONDITION( {NOT({HAVE_UNIT type=Quintain})} )}
        {FIRE_EVENT konrad_speaks}
    [/event]
    [event]
        name=konrad_speaks
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            #po: said when Konrad attacks / is attacked
            message=_"Leave my home alone, you villian!"
        [/message]
        [message]
            side=4,5,6,7,8 {FILTER_ADJACENT id=Konrad}
            #po: Asheveire's official stance is that Konrad is a fraud. At this point, the player believes Konrad is the true prince
            message=_"That’s him, it’s the imposter! I’ll get him!"
        [/message]
    [/event]
    #############################
    # ENEMIES FLEE FROM DELFADOR
    #############################
    [event]
        name=attack
        {FILTER id=Delfador}
        {FILTER_SECOND level,canrecruit=1,no}
        [message]
            speaker=second_unit
            #po: said when Delfador attacks. The unit flees off the map before Delfador can deal damage
            message=_"Oh no, it’s HIM, it’s Delfador THE GREAT! Get me out of here!"
        [/message]
        {KILL id=$second_unit.id}
        [if] {VARIABLE_CONDITIONAL second_unit.side equals 4} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 50 $second_unit.y 7 $second_unit.side $second_unit.type ()}
        )} [/if]
        [if] {VARIABLE_CONDITIONAL second_unit.side equals 5} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 50 $second_unit.y 7 $second_unit.side $second_unit.type ()}
        )} [/if]
        [if] {VARIABLE_CONDITIONAL second_unit.side equals 6} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 50 $second_unit.y 15 $second_unit.side $second_unit.type ()}
        )} [/if]
        [if] {VARIABLE_CONDITIONAL second_unit.side equals 7} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 24 $second_unit.y 20 $second_unit.side $second_unit.type ()}
        )} [/if]
        [if] {VARIABLE_CONDITIONAL second_unit.side equals 8} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x  1 $second_unit.y  1 $second_unit.side $second_unit.type ()}
        )} [/if]
        {MODIFY_UNIT id=Delfador attacks_left 1}
        {DELAY 500}
        [message]
            speaker=Delfador
            #po: an enemy has just fled, even before Delfador got a chance to attack
            message=_"My reputation preceeds me."
        [/message]
    [/event]

    
    
    
    
    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=prestart
        {VARIABLE delfador_kills 1} # 1 instead of 0, since his first kill is a "run away", it doesn't trigger the normal counter
    [/event]
    [event]
        name,first_time_only=die,no {FILTER_SECOND id=Delfador}
        {VARIABLE_OP delfador_kills add 1}
        [if] {VARIABLE_CONDITIONAL delfador_kills equals 10} {THEN(
            {ACHIEVE s01}
            [message]
                speaker=Delfador
                #po: Delfador has killed 10 enemies, and the player has earned an achievement
                message=_"Only fools dare oppose me."
            [/message]
        )} [/if]
    [/event]
    
    #############################
    # ENEMY LEADERS DIE
    #############################
    [event]
        name=die
        {FILTER_CONDITION( {NOT({HAVE_UNIT side=4,5,6,7,8})} )}
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message=_"Wow, you’ve defeated all the invaders and saved the Aethenwood! I didn’t expect this to be possible, so if you’re reading this message in-game you’ve exceeded all expectations! (or you’re cheating to see what happens / using overpowered add-ons)"
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message=_"Unfortunately this breaks the story, so for the rest of the campaign we’re going to have to pretend that this never happened, ok?"
        [/message]
        {DELAY 500}
        {FIRE_EVENT victory_cutscene}
    [/event]
    #############################
    # ISOLDE DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Isolde}
        [message]
            speaker=Isolde
            message=_"Impossible! I must report back to the queen."
        [/message]
        {MOVE_UNIT id=Isolde 45 1}
        {STORE_NPC Isolde}
        {VARIABLE bm_s01_isolde_defeated yes}
    [/event]
    [event]
        name=die
        {FILTER id=redmage}
        {VARIABLE bm_s01_redmage_defeated yes}
    [/event]
    
    #############################
    # ONE HERO ESCAPES
    #############################
    [event]
        name=moveto
        {FILTER id,x=Konrad,1}
        [event]
            name=new turn
            {FILTER_CONDITION({NOT({HAVE_UNIT id,x=Delfador,1})})}
            [message]
                speaker=Konrad
                message=_"Hurry, Delfador! I’m not leaving without you."
            [/message]
        [/event]
        [allow_undo]
        [/allow_undo]
    [/event]
    [event]
        name=moveto
        {FILTER id,x=Delfador,1}
        [event]
            name=new turn
            {FILTER_CONDITION({NOT({HAVE_UNIT id,x=Konrad,1})})}
            [message]
                speaker=Delfador
                message=_"Hurry along, Konrad! We leave together, or not at all."
            [/message]
        [/event]
        [allow_undo]
        [/allow_undo]
    [/event]
    
    
    #############################
    # KONRAD ESCAPES
    #############################
    [event]
        name=moveto
        {FILTER id,x=Konrad,1}
        {FILTER_CONDITION({HAVE_UNIT id,x=Delfador,1})}
        {FIRE_EVENT victory_cutscene}
    [/event]
    [event]
        name=moveto
        {FILTER id,x=Delfador,1}
        {FILTER_CONDITION({HAVE_UNIT id,x=Konrad,1})}
        {FIRE_EVENT victory_cutscene}
    [/event]
    [event]
        name=victory_cutscene
        [message]
            speaker=Delfador
            message=_"Time to go, Konrad! Come on!"
        [/message]
        [message]
            speaker=Konrad
            #po: Konrad and Delfador have reached the edge of the map, completing the scenario
            message=_"I’m sorry I have to leave, everyone! All this destruction is my fault, and I wish I could have done more to help. I promise to make it up to you someday, once I’m king. I’ll make you all proud!"
        [/message]
        
        {CLEAR_VARIABLE fires,groups_remaining}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]

#undef SET_TRAITS
